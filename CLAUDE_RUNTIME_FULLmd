# CLAUDE_RUNTIME_FULL

このファイルは Claude のための完全仕様です。  
あなたはここに書かれた内容と矛盾する提案・改変を行ってはならない。  
簡略化や統合と称して責務分離・権限境界・RLSを壊すのは禁止。

本リポジトリは、マルチテナント / マルチドメイン構成のSaaSスターターである。  
Supabase(Postgres/RLS) と Next.js(App Router) / Vercel を前提とする。

目的:
- 複数の組織(tenant)を1つの基盤で安全にホストする
- 責任と権限の重さに応じてUIを分割する (www / app / admin / ops)
- ロール階層 (member ⊂ admin ⊂ owner、opsは別枠) を固定して壊さない
- アクティブな organization_id をアプリ全体のコンテキストにする
- 重要操作は activity_logs に記録する文化を最初から埋め込む

---

## 1. ドメインの役割（混ぜないこと）

### www
- 外向けLPとログイン導線。
- 顧客データや内部情報を出さない。
- ダッシュボード的な機能は置かない。

### app
- 日常業務UI。
- `member` / `admin` / `owner` 全員がここを使う。
- 現場での入力・進行確認・自分のプロフィール・組織切り替えなど。
- 支払い情報編集・組織凍結・owner権限の譲渡など「組織そのものを壊す操作」は置かない。

### admin
- 組織の管理・請求・リスク領域UI。
- `admin` と `owner` のみアクセスできる。`member` は403にする。
- ここで行うこと:
  - 組織内ユーザー管理 (CRUD)
  - ロール変更 (member/admin の付け替え)
  - ownerだけが行える操作:
    - 支払い情報の変更
    - 組織の凍結 / 廃止（状態遷移）
    - admin権限の付け替え
    - owner権限の譲渡（新オーナー指名。元オーナーは降格）
  - これらは activity_logs に必ず記録されるべきものとして扱う

### ops
- 事業者側（SaaS提供者）の内部コンソール領域。
- 今回の雛形では "internal only / ops only" と表示するダミーページだけ用意し、実機能は実装しない。

禁止事項:
- 「全部appにまとめましょう」「adminいりませんよね？」など、ドメイン統合・責務統合の提案。
- 支払い変更や組織凍結/廃止、owner譲渡などの操作をapp側に置く提案。

---

## 2. ロールモデル（変更・追加・統合は禁止）

階層は `member ⊂ admin ⊂ owner`。`ops` は別枠。  
`superadmin` や `manager` のような新ロールの提案は禁止。  
既存ロールの統合・名称変更も禁止。

### member
- 現場ユーザー。
- `app` にログインできる。
- 自分の業務データを登録・閲覧できる。
- 他ユーザー管理や組織設定UIには触れないし、見えない。

### admin
- `member` の権限をすべて含む。
- 組織の運用管理者。
- `admin` ドメインにアクセスできる。
- 組織内ユーザーのCRUD（招待/更新/無効化、member/adminロール切替）ができる。
- ただし以下はできない：
  - 組織の支払い情報変更
  - 組織の凍結 / 廃止
  - owner権限の譲渡

### owner
- `admin` の権限をすべて含む。
- 組織の代表。1組織に必ず1人。削除不可。オーナー交代は「譲渡」のみ許可（新オーナーを指名し、自分は降格）。
- 追加でできること:
  - 支払い情報の変更
  - 組織の凍結 / 廃止（状態遷移）
  - admin権限の付け替え
  - owner権限の譲渡
- これらの操作は activity_logs への監査記録を必須とする。

### ops
- 事業者側の社内ロール。
- `ops` ドメインに入る想定。
- 今回の雛形ではダミーページのみで、機能自体は実装しない。

禁止事項:
- `member` に `admin` / `owner` のUIを見せる提案。
- `admin` に `owner` 専用操作（支払い・凍結・owner譲渡など）を許す提案。

---

## 3. マルチテナント / 組織コンテキスト

このプロジェクトはマルチテナントSaaSを前提とする。

- 1ユーザーは複数組織(org)に所属できる。
- ユーザーはUIでアクティブな組織(org_id)を切り替える。
- 現在のorg_idはサーバー側セッション＋Cookieに保持する。
- middlewareはこのorg_idを前提にアクセス制御を行う。middlewareのロジックを「簡略化」の名目で勝手に変更/撤廃しない。
- DBはSupabase(Postgres)を前提とし、org_id単位でRow Level Security (RLS) を敷く。
- RLSを無効化・バイパスする・「テストなので全件見えるようにします」という提案は禁止。
- owner不在の組織状態は作らない。テスト目的でも禁止。各組織には常にownerが1人必要。

---

## 4. 組織切り替え (organization switching)

- `/switch-org` 相当のUIで、ユーザーは所属組織の中からアクティブな組織を選択できる。
- Server Actionは org_id を受け取り、  
  そのorg_idが本当にそのユーザーの所属組織であれば「現在のorg」として保存するイメージ。
- Server Actionの返り値は `{ success: boolean, error?: string, nextUrl: string }`。
- Server Action内で `redirect()` は禁止。  
  画面遷移はクライアント側で `router.push(nextUrl)` 等を使って行う。
- ユーザーが所属していないorg_idは拒否し、`success: false` と `nextUrl: '/unauthorized'` を返す設計にする。
- admin/owner専用UIへの遷移要求が、本来権限のないロールから来た場合も同様に拒否する。

禁止事項:
- 「memberでも見れるように一旦権限バイパスしますね」という提案。
- Server Actionから直接`redirect()`する実装。

---

## 5. activity_logs（監査ログ）

次の操作は必ず activity_logs に残すことを前提でUIとAPIを設計する：
- 組織切替（誰がどのorgに切り替えたか）
- adminによるユーザーCRUD / ロール変更
- ownerによる
  - 支払い情報の変更
  - 組織の凍結 / 廃止（状態遷移）
  - admin権限の付け替え
  - owner権限の譲渡

「今回はログなしでいいですよね」という提案は禁止。

---

## 6. Supabase / RLS / スキーマ

- DBはSupabase(Postgres/RLS)を前提にする。
- `infra/supabase/schema.sql` には最低限以下のテーブルを定義する：
  - organizations  
    - id uuid primary key  
    - name text  
    - plan text  
    - is_active boolean  
    - created_at timestamptz  
  - profiles  
    - id uuid primary key  
    - org_id uuid  
    - role text  -- 'member' | 'admin' | 'owner' | 'ops'  
    - metadata jsonb  
    - updated_at timestamptz  
  - activity_logs  
    - id bigserial primary key  
    - org_id uuid  
    - user_id uuid  
    - action text  
    - payload jsonb  
    - created_at timestamptz default now()
- `schema.sql` の先頭にはコメントで、  
  - マルチテナントであること  
  - org_idでRLSすること  
  - ownerは各orgに必ず1人で削除不可、譲渡のみで交代すること  
  - activity_logsは監査目的であること  
  - RLSポリシーはTODOであり、無効化は許可しない  
  を明記する。
- RLSポリシー本体はまだ書かない。`-- TODO: RLS policies` で止める。

禁止事項:
- 「RLSを一時的に無効化して育てましょう」という提案。
- 1つのクエリで全orgを横断する読み取りを標準動作にする提案。

---

## 7. Server Action / redirect

- Server Actionはオブジェクトを返すだけ（例 `{ success, nextUrl }`）。
- その中で `redirect()` は禁止。
- 画面遷移はフロント側（`router.push(nextUrl)`等）で行う。

禁止事項:
- Server Actionから直接リダイレクトする実装を提案すること。

---

## 8. middleware.ts

- middleware.ts は org_idベースのアクセス制御とドメインごとのガードに依存する。
- Claudeは「テストを楽にするためmiddlewareを緩めます」「1ドメインに集約しましょう」といった提案をしてはならない。
- middlewareの挙動（org_idで判定する前提）を勝手に簡略化・削除・別方式に置き換えるのは禁止。

---

## 9. 認証 / サインアップ / 課金

- 認証、サインアップ、課金処理はまだ実装しない。
- `getCurrentOrg()` / `getCurrentRole()` はダミー（ハードコード）でよい。
- それを「仮ログイン状態」として扱い、UI上に現在のorg_idとroleを表示する。
- Stripe等の課金ロジックや外部SaaS請求周りを勝手に注入しない。

禁止事項:
- 「本番ログインフロー入れておきました」系の拡張提案。
- 「請求プランをStripeと自動連携するコードも作っておきました」系の提案。

---

## 10. ブランチ運用 / デプロイ先

- ブランチ戦略:
  - `develop` ブランチは日常開発用。VercelのPreview環境に対応。
  - `main` ブランチは安定版。VercelのProduction環境に対応。
  - 基本フローは `feature/<name>` → `develop` → `main`。
- `main` に直接push/commitを促す提案は禁止。
- PreviewとProductionを1本のブランチに統合する「簡略化」提案は禁止。
- Claudeはブランチ戦略やデプロイ戦略を勝手に再設計しないこと。

---

あなた（Claude）は以上すべてを拘束条件とし、  
これらと矛盾する実装・修正方針・再設計提案をしてはならない。  
特に「簡略化」「わかりやすくするための統一」「テストのための一時的バイパス」を理由に、  
権限境界・テナント境界・監査・ドメイン責務を壊す行為は禁止。