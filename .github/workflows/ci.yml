name: CI

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      NEXT_PUBLIC_WWW_URL: http://www.local.test:3001
      NEXT_PUBLIC_APP_URL: http://app.local.test:3002
      NEXT_PUBLIC_ADMIN_URL: http://admin.local.test:3003
      NEXT_PUBLIC_OPS_URL: http://ops.local.test:3004
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      # CI環境で.local.testドメインを使えるように/etc/hostsを設定
      # これにより異なるポート間でCookie共有が可能になる
      - name: Setup local.test domains
        run: |
          echo "127.0.0.1 www.local.test" | sudo tee -a /etc/hosts
          echo "127.0.0.1 app.local.test" | sudo tee -a /etc/hosts
          echo "127.0.0.1 admin.local.test" | sudo tee -a /etc/hosts
          echo "127.0.0.1 ops.local.test" | sudo tee -a /etc/hosts
          cat /etc/hosts

      # ビルドキャッシュをクリア（next.config.mjsの変更を確実に反映させるため）
      - name: Clean build cache
        run: rm -rf apps/*/.next apps/*/.turbo .turbo

      # @repo/db を先にビルド（dist配布を前提）
      - name: Build workspace
        run: pnpm -w build

      # ガード（失敗でCI落とす）
      - name: Edge guard
        run: bash scripts/ci/edge_guard.sh

      - name: Redirect guard
        run: bash scripts/ci/redirect_guard.sh

      - name: Type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm -w lint

      # 環境変数の存在チェック
      - name: Validate E2E environment variables
        run: |
          test -n "$E2E_TEST_PASSWORD" || (echo "❌ Missing E2E_TEST_PASSWORD secret" && exit 1)
          test -n "$NEXT_PUBLIC_SUPABASE_URL" || (echo "❌ Missing NEXT_PUBLIC_SUPABASE_URL secret" && exit 1)
          test -n "$NEXT_PUBLIC_SUPABASE_ANON_KEY" || (echo "❌ Missing NEXT_PUBLIC_SUPABASE_ANON_KEY secret" && exit 1)
          test -n "$SUPABASE_SERVICE_ROLE_KEY" || (echo "❌ Missing SUPABASE_SERVICE_ROLE_KEY secret" && exit 1)
          echo "✅ All required E2E environment variables are set"

      # テストユーザーのシード（CI環境でSupabaseにユーザーを作成/更新）
      - name: Seed test user
        run: pnpm tsx scripts/seed-test-user.ts

      - name: Install Playwright
        run: pnpm dlx playwright install --with-deps chromium

      # E2E（playwright.config.ts で webServer/baseURL を管理）
      # 全フェーズを順次実行（p1→p2→p3→p4）（Chromiumのみ - Firefoxは安定性の問題により除外）
      # 各フェーズ間でデータベースをリセットして確実性を確保
      - name: Run E2E Phase 1
        run: pnpm -w test:e2e --project=p1-chromium

      - name: Reset data before Phase 2
        run: pnpm tsx scripts/seed-test-user.ts

      - name: Run E2E Phase 2
        run: pnpm -w test:e2e --project=p2-chromium

      - name: Reset data before Phase 3
        run: pnpm tsx scripts/seed-test-user.ts

      - name: Run E2E Phase 3
        run: pnpm -w test:e2e --project=p3-chromium

      - name: Reset data before Phase 4
        run: pnpm tsx scripts/seed-test-user.ts

      - name: Run E2E Phase 4
        run: pnpm -w test:e2e --project=p4-chromium

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          if-no-files-found: ignore

      - name: Upload traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/
          if-no-files-found: ignore
