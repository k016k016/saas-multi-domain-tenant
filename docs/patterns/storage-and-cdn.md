# ストレージ / CDN パターン（Cloudflare R2 / Images など）

このドキュメントでは、Cloudflare を画像置き場（ストレージ＋CDN）として使うときの
基本方針と、このスターター上で守りたいルールをまとめます。

前提:

- Cloudflare は「画像/CDN基盤」として使う
- 認可・テナント分離（org）は **アプリ側 + RLS** で担保する
- 「直リンクで誰でも見える」は禁止したい

---

## 役割分担のイメージ

- **Cloudflare（R2 / Images / CDN）**
  - 画像ファイルの保存と配信
  - オリジンサーバーの負荷軽減
  - 地理的に近い PoP から配信

- **アプリ（Next.js / Supabase）**
  - 「どの org がどの画像にアクセスしてよいか」の判定
  - `files` テーブルなどによるメタデータ管理（`org_id`, パス, MIME, サイズ 等）
  - 必要に応じたリサイズ・変換（Next Image / Cloudflare 側の変換機能）

---

## 直リンクを禁止する方針

「直リンク不可」のイメージを実現するため、基本方針を次のどちらかに限定します。

1. **アプリ経由でのみ画像を出す（プロキシ方式）**
2. **期限付きの署名付き URL だけを使う（短命 URL 方式）**

### 1. プロキシ方式（推奨）

- Next.js の Route Handler などで `/files/:id` のようなエンドポイントを用意する
- その中で:
  - Supabase の `files` テーブル（例）から `org_id`, Cloudflare 上のキーを取得
  - 現在のユーザーの `org_id` / ロールをチェック
  - OK なら Cloudflare からフェッチしてストリーム返却
- ユーザーには `https://app.example.com/files/abc123` のような URL だけを見せる
  - Cloudflare R2 / Images の実 URL は外部に公開しない

この方式だと、アプリ側で org / ロール / RLS をフルに使えるため、マルチテナントとの相性が良いです。

### 2. 署名付き URL 方式

- Cloudflare 側の機能（署名付き URL 等）で、短命の URL を発行する
- アプリはその URL を一時的にユーザーに返すだけ
- URL が漏れても短時間で無効になるため、「恒久的な直リンク」はできない

この方式を採用する場合も、**どの画像に署名 URL を出してよいか** は必ずアプリ側で判定します。

---

## files テーブルと org 分離

マルチテナントで画像を扱う場合、ファイルメタデータ専用のテーブルを持つことを推奨します。

例（概念レベル）:

- `files` テーブル
  - `id`: uuid
  - `org_id`: 組織 ID（RLS でスコープ）
  - `path`: Cloudflare 上のキー（例: `orgId/uuid.jpg`）
  - `mime_type`, `size`, `created_at` など

ポイント:

- `org_id` を必ず持たせ、RLS を有効にする（他 org のファイルは DB 層で見えない）
- Cloudflare 側のキーも `orgId/fileId` のように org 単位で分けておくと整理しやすい

このテーブルに対する SELECT / INSERT / DELETE も、他の業務データと同様に RLS 前提で設計します。

---

## Cloudflare 側の公開設定について

直リンク禁止のイメージを守るため、Cloudflare 側は次のように扱います。

- バケット/エンドポイントを「完全公開」にしない（誰でも URL で読める設定は避ける）
- どうしても公開バケットを使う場合でも、**予測しにくいキー + 短命の署名 URL** を前提にする
- WAF や IP 制限だけで守ろうとせず、最終的なアクセス制御はアプリ + RLS に寄せる

---

## このスターターに入れるもの / 入れないもの

**入れるもの（共通化したいもの）**

- 「Cloudflare = 画像/CDN基盤、認可はアプリ側」という役割分担の方針
- `files` 的なメタデータテーブル + RLS で org 分離するという考え方
- プロキシ方式 / 署名付き URL 方式という 2 パターンの整理

**入れないもの（各プロダクトごとに決めるもの）**

- 具体的な Cloudflare サービス選定（R2 / Images / Workers など）
- 画像のライフサイクル（保存期間・削除ポリシー）
- サムネイル生成戦略（オンデマンド変換 or バッチ生成）

この分割により、「Cloudflare を画像置き場として使う」前提を持ちつつも、
実際の運用や画質・コストに関する判断は、各プロダクトに委ねられるようにしています。

