# tenancy.md
マルチテナント / テナント境界 / 権限モデル / 組織コンテキストの仕様。

本プロジェクトは「1つのアプリ基盤の上で複数の組織(tenant)を安全にホストする」SaaSを前提としている。
この前提は変えない。

---

## 基本前提
- DBはPostgres/Supabaseを想定する。
- 全ての業務データは `org_id`（組織ID）でスコープされる。これはテナント境界であり、最優先の安全ライン。
- Row Level Security (RLS) は必須。RLSを無効化したり、バイパスして全組織を横断閲覧できるようにする提案は不可。
- 各ユーザーは複数の組織(org)に所属できる。
- ユーザーはUI上で「現在アクティブな組織(org_id)」を切り替えることができる。
- 現在のorg_idはサーバー側セッションとCookieで保持される。
- middleware はこのorg_idを前提にアクセス制御・ガードを行う。簡略化・撤廃・統合提案は禁止。

将来的には Supabase Auth をユーザー認証のソースとする想定だが、現時点では本番運用の認証/サインアップフローは未実装である。  
今は `getCurrentOrg()` / `getCurrentRole()` をハードコードしたダミー実装でログイン状態をエミュレートする。

---

## ロール・権限モデル
ロールは固定とする。勝手な追加・統合・改名は禁止。
`member ⊂ admin ⊂ owner` で階層になり、`ops` はSaaS提供側の別枠。

### member
- 現場ユーザー。
- appドメインにアクセスできる。
- 自分の業務データを登録・閲覧できる。
- 他ユーザー管理や組織の設定など、高リスクの操作は行えない。
- adminドメインには入れない（middlewareで403）。

### admin
- member権限をすべて含むため、appドメインも利用できる。
- さらにadminドメインにアクセスできる。
- adminドメインでは、同一組織内のユーザー管理を行える:
  - ユーザー招待・更新・無効化
  - member/adminロールの切り替え
- ただし以下は不可:
  - 支払い情報の変更
  - 組織の凍結 / 廃止
  - owner権限の譲渡
- これら「不可」の操作はowner専用扱いであり、adminが扱えるようにしてはならない。

### owner
- admin権限をすべて含む。
- 組織の代表。1組織につき必ず1人だけ存在すること。owner不在の組織状態は作らない（テストでも禁止）。
- ownerユーザーは削除不可。交代は「owner権限の譲渡」で行い、譲渡後は元ownerが降格する。
- 追加でできること（adminには不可の領域）:
  - 組織の支払い情報の変更
  - 組織の凍結 / 廃止（状態遷移として扱う）
  - admin権限の付け替え
  - owner権限の譲渡
- これらはすべて監査ログ(activity_logs)に必ず記録されること。

### ops
- SaaS提供側の社内ロール。
- opsドメインにアクセスする立場。
- 本雛形ではダミーページのみであり、実業務機能はまだ実装しない。
- 現段階ではRLSをバイパスして全組織横断で見るような特権アクセスは実装しない。

---

## 組織切り替え (organization switching)
- ユーザーは所属している複数の組織(org)の中から、現在アクティブなorgを選べるUI（例: `/switch-org`）を持つ。
- 切り替えフロー（想定）:
  1. ユーザーがUIから特定のorgを選択する
  2. Server Actionにorg_idを送る
  3. Server Action側で「そのユーザーはそのorgに所属しているか」を必ず検証する
  4. 有効ならサーバー側セッション＋Cookieに新しいorg_idをセットする
  5. Server Actionは `{ success: boolean, error?: string, nextUrl: string }` を返す  
     - `redirect()` はServer Action内で禁止
  6. フロント側が `nextUrl` に遷移する（例: `router.push(nextUrl)`）

- 権限のない領域をリクエストした場合の戻り値例:
  ```ts
  {
    success: false,
    error: 'この組織にはアクセス権がありません',
    nextUrl: '/unauthorized'
  }