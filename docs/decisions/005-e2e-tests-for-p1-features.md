# Decision 005: roadmap P1機能に対するE2Eテスト実装

**日付**: 2025-11-01
**ステータス**: 実装完了
**関連**: roadmap.md (P1: 基礎機能)

---

## 背景

roadmap.mdのP1（基礎機能）として以下が定義されているが、E2Eテストが未実装だった：

- admin/members CRUD（招待・有効化・ロール変更・削除）
- 監査ログ閲覧UI（期間/ユーザー/アクションの簡易絞り込み）
- UX最小整備（/unauthorized と error.tsx）

これらの機能実装を進める前に、既存の成功しているテストパターンに沿ったE2Eテストを作成する必要があった。

---

## 実装したテストファイル

### 1. `e2e/tests/admin/members-crud.spec.ts` (79行)

**テスト対象**:
- メンバー一覧ページへのアクセス制御（admin/owner: OK, member: 404）
- 招待フォームの表示確認
- ユーザー招待機能（タイムスタンプ付き一意メール使用）
- ロール変更UIの表示確認
- 削除UIの表示確認
- owner削除不可の確認

**重要な設計判断**:
- 招待テストでは `e2e+${timestamp}@example.com` 形式で一意メールアドレスを生成
- 既存テストユーザー（member1/admin1/owner1）は変更・削除しない
- 実際の削除は実行せず、UIの存在確認のみ（docs/test-data/README.md に準拠）

### 2. `e2e/tests/admin/audit-logs.spec.ts` (67行)

**テスト対象**:
- 監査ログページへのアクセス制御（admin/owner: OK, member: 404）
- ログテーブルの表示確認
- フィルタUI（アクション種別・期間）の存在確認
- フィルタリング動作のテスト（URLパラメータ変更の確認）

**重要な設計判断**:
- URL候補のループ処理は削除（実装は `/audit-logs` のみ）
- ユーザー絞り込みUIは実装されていないため削除
- フィルタはURLパラメータ変更で検証（`/action=org_switched`, `/days=30`）

### 3. `e2e/tests/common/error-handling.spec.ts` (64行)

**テスト対象**:
- 未認証時のリダイレクト（→ ログインページ）
- アクセス権限エラー（member → admin domain: 404）
- /unauthorizedページの表示確認（admin/app domain）
- /unauthorizedからのホームリンク動作確認
- 存在しないページの404エラーテスト
- 招待フォームのバリデーションエラーテスト

**重要な設計判断**:
- 複雑なエラー境界テストは削除（実装詳細が不明確なため）
- ネットワークエラーシミュレーションは削除（既存パターンにない）
- シンプルなHTTPステータスコード検証に統一

---

## 既存パターンとの統一

### 削除したアンチパターン

1. **複雑なセレクタ**:
   - ❌ `.or()` チェーン、複数候補の試行
   - ❌ `data-testid` の使用
   - ❌ 推測ベースの汎用セレクタ（`input[name="email"]` など）

2. **不適切な待機方法**:
   - ❌ `page.waitForTimeout()` の使用
   - ❌ 過度なタイムアウト明示指定

3. **実装されていない機能のテスト**:
   - ❌ ユーザー絞り込みUI（audit-logsページに存在しない）
   - ❌ 監査ログへのリンク（membersページに存在しない）
   - ❌ 複雑なエラー境界テスト

4. **テスト構造の問題**:
   - ❌ 過度なネスト（`test.describe()` の多用）
   - ❌ 1テストで複数検証
   - ❌ 条件分岐の多用

### 採用した成功パターン

1. **セレクタの書き方**:
   - ✅ 実装に合わせた正確なIDセレクタ（`#email`, `#role`, `#action`, `#days`）
   - ✅ `getByRole()` 優先（アクセシビリティ重視）
   - ✅ `getByText()` での正規表現マッチング

2. **テスト構造**:
   - ✅ 1テスト1検証のシンプルな構造
   - ✅ 明確で読みやすい日本語のテスト名
   - ✅ playwright.config.ts のデフォルトタイムアウトを使用

3. **待機とアサーション**:
   - ✅ `toBeVisible()` で要素の表示確認
   - ✅ `toHaveURL()` で正規表現を使ったURL確認
   - ✅ `res?.status()` で直接HTTPステータスコードをチェック

4. **テストデータの扱い**:
   - ✅ 既存のseedユーザー（member1/admin1/owner1）を使用
   - ✅ 新規作成時はタイムスタンプ付き一意メールアドレス
   - ✅ 既存ユーザーのロール変更・削除は行わない

---

## 参照した既存テスト

以下の成功しているテストを参考にした：

- `e2e/tests/app/boundary.spec.ts`
- `e2e/tests/admin/boundary.spec.ts`
- `e2e/tests/www/login-cookies-await-smoke.spec.ts`
- `e2e/helpers/auth.ts`（uiLogin関数）
- `e2e/helpers/domains.ts`（DOMAINS定数）

---

## 遵守したドキュメント

- `docs/test-data/README.md`: テストユーザー・組織の扱い方
- `CLAUDE_RUNTIME_FULL.md`: ロール階層、アクセス制御の仕様
- `docs/roadmap.md`: P1機能の定義
- `playwright.config.ts`: タイムアウト設定、プロジェクト構成

---

## 今後の作業

これらのE2Eテストは、P1機能の実装が進むにつれて以下のように更新される：

1. **members CRUD実装後**:
   - ロール変更の実際の動作テスト追加
   - 削除機能の動作テスト追加（owner削除不可の検証強化）

2. **監査ログ閲覧UI実装後**:
   - ログエントリの詳細表示テスト追加
   - ページネーションテスト追加（実装される場合）

3. **error.tsx実装後**:
   - エラーページのレイアウト・文言検証追加
   - 再試行ボタンの動作確認追加

---

## 変更履歴

- 2025-11-01: 初版作成（3つのE2Eテストファイル実装）
