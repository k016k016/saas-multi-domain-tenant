# ドメイン分割と責務境界

このプロジェクトは「ドメインごとの責務と権限境界を、物理的に分離する」ことを最優先とする。  
www / app / admin / ops は別アプリとしてデプロイされ、統合しない。

## ドメイン一覧

### www
- 目的: LP、営業導線、ログイン導線などの外向けプレゼンス。
- 想定ユーザー: 未ログインの訪問者 / これから利用開始する組織。
- データ扱い: 機密データ・組織内部データは基本的に表示しない。
- 注意:
  - ここに管理系UI（メンバー管理、請求、組織凍結など）を置かない。
  - ここにapp/admin/opsの画面を間借りさせない。
  - `www` の middleware は `www` のためだけに存在する。他ドメインをrewriteしない。

### app
※ 将来的には `portal` 等へリネーム予定だが、ここでは `app` と呼ぶ。

- 目的: 日常業務UI。メンバーが普段使うアプリ本体。
- 想定ユーザー: `member` / `admin` / `owner`
  - `member`: 現場ユーザー
  - `admin`: 組織の運用管理者
  - `owner`: 組織の代表
- 主な機能:
  - 各ユーザーの業務データの登録・閲覧
  - 現在の所属組織(org_id)コンテキストに基づいた表示
  - 組織切り替えUI（自分が所属するorgの中からアクティブorgを変更する）
- 置いてはいけないもの:
  - 請求情報の変更
  - 組織の凍結/廃止
  - owner権限の譲渡
  - admin権限の付け替え
  - これらは「組織の生殺与奪」に該当するため、`admin` ドメインに閉じ込める。

### admin
- 目的: 組織の管理・権限付与・請求/契約・シャットダウン系操作。
- 想定ユーザー: `admin` / `owner` のみ（`member` は403で拒否する）
  - `admin`: 組織運用管理者
  - `owner`: 組織の代表。必ず1名存在し、削除不可。譲渡のみで交代。
- 主な機能:
  - 組織内ユーザーのCRUD（招待、更新、無効化）
  - `member` / `admin` ロールの付け替え
  - 請求情報の変更（ownerのみ）
  - 組織の凍結/廃止（ownerのみ。状態遷移として扱う）
  - owner権限の譲渡（新オーナーを指名し、自分は降格する）
  - admin権限の再割り当て（ownerのみ）
- 監査:
  - 上記の「重要操作」は全て `activity_logs` に記録されることが前提。
  - 記録対象例: ユーザー招待・ロール変更・請求情報変更・組織凍結/廃止・owner権限譲渡など。

- 制約:
  - `admin` のmiddlewareは `role !== 'admin' && role !== 'owner'` を即座に拒否する。
  - `member` が `admin` 画面に入れる挙動はバグ扱い。テスト目的でも許容しない。
  - `admin` の画面やAPIを `app` 側にコピーして「使いやすいので統合しました」は禁止。

### ops
- 目的: SaaS提供側の運用・サポート・監査用。
- 想定ユーザー: `ops` のみ。
- 現状:
  - プレースホルダ状態。将来、複数組織を横断したサポートやインシデント対応、監査ビューなどを扱う予定。
- 重要な制約:
  - `ops` は「RLSを無効化して全部見放題の神ツール」ではない。
  - RLSをバイパスして生データ全件を閲覧できるようにする、といった提案は受け付けない。
  - 監査・サポートに必要な範囲でも、org_id境界と記録（activity_logs）を維持すること。

---

## アクセス制御とmiddleware

- 各ドメインはそれぞれ独立したNext.jsアプリとして動作し、**各自が自分専用の `middleware.ts` を持つ**。
- 認可チェック（どのroleを許すか）は、そのドメイン自身のmiddlewareで完結させる。

禁止事項:
- `www` のmiddlewareが「サブドメイン/ホスト名を見てadmin側にrewriteする」など、他ドメインのゲートウェイになる構成。
- 1つのアプリに全画面を抱えて、ホスト名ベースで出し分ける構成。

理由:
- 物理的にビルド成果物を分けておくことで、誤権限ユーザーに危険UIが届かないようにするため。
- インシデント時の影響範囲を分け、ロールバックや監査説明を行いやすくするため。

---

## まとめ

- www / app / admin / ops は、責務・ユーザー層・リスクが異なる。混ぜない。
- app は日常業務。admin は権限と生殺与奪。ops は事業者監査。www は外向け。
- admin領域の機能（請求・凍結・owner譲渡など）を app 側に置くことは禁止。
- middlewareは各アプリ単位で持ち、他ドメインを肩代わりしない。
- これらはセキュリティと監査の土台なので、コストや実装簡略化を理由に崩さない。