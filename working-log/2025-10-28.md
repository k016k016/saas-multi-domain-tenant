# 作業ログ 2025-10-28

## 初期スケルトン生成

### 実施内容

CLAUDE_RUNTIME_FULLmdの前提を厳守し、マルチテナント/マルチドメインSaaSスターターの初期スケルトンを生成しました。

### 生成された構成

#### 1. ディレクトリ構成
- `apps/www` - 外向けLP・ログイン導線
- `apps/app` - 日常業務UI（member/admin/owner全ロール対象）
- `apps/admin` - 組織管理・請求（admin/owner専用）
- `apps/ops` - 事業者側コンソール（ダミーのみ）
- `packages/config` - 共通設定・認証ダミー実装
- `packages/db` - Supabaseクライアント
- `infra/supabase/schema.sql` - DB定義（RLS前提）
- `docs/` - 仕様書・ドメイン責務文書

#### 2. 実装されたページ

**www:**
- `/` - LPダミー（説明文とログインボタン）

**app:**
- `/dashboard` - org_id/role表示、業務ダッシュボード
- `/switch-org` - 組織切替UI（Server Action呼び出し想定のコメント付き）

**admin:**
- `/overview` - 組織サマリ表示
- `/members` - ユーザー管理UI（CRUD・ロール変更）
- `/org-settings` - owner専用（支払い変更・組織凍結/廃止・owner譲渡）

**ops:**
- `/` - "internal only / ops only" ダミーページ

#### 3. 主要ファイル

- `packages/config/src/auth.ts` - `getCurrentOrg()` / `getCurrentRole()` ダミー実装
- `infra/supabase/schema.sql` - organizations/profiles/activity_logs テーブル定義
- `.env.example` - 4ドメインURL + Supabase設定のテンプレート
- `README.md` - プロジェクト概要・責務分離・禁止事項の明記
- `docs/domains.md` - ドメイン責務一覧
- `docs/spec/tenancy.md` - マルチテナント仕様

### 守られた制約

✅ ロールは `member` / `admin` / `owner` / `ops` のみ（新規追加・統合なし）
✅ memberはadminドメインにアクセス不可（403想定）
✅ 支払い・凍結・owner譲渡は `/org-settings` のみ（app側に置かない）
✅ Server Actionで `redirect()` 禁止（`{ success, nextUrl }` で返す方針を明記）
✅ RLSは `TODO` で止め、無効化提案なし
✅ middlewareの前提（org_idベースのアクセス制御）を崩さない

### 技術スタック

- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **DB**: Supabase (Postgres with RLS)
- **デプロイ**: Vercel想定
- **モノレポ**: Turborepo + pnpm workspace

### v0のゴール

- ✅ 骨格: 4ドメイン構成
- ✅ 契約: 責務分離・権限境界・RLS前提・監査文化
- ❌ 業務ロジック: 未実装
- ❌ 課金: 未実装
- ❌ 本番Auth: 未実装（ダミー実装のみ）

### 次のステップ候補

1. Supabase Authの統合
2. middlewareの実装（org_id/roleベースのアクセス制御）
3. Server Actionsの実装（組織切替、ユーザーCRUD）
4. RLSポリシーの実装
5. 業務ロジックの追加
6. Stripe等の課金統合

### コンテキスト使用状況

- **モデル**: claude-sonnet-4-5-20250929
- **使用トークン**: 67k/200k (34%)
  - システムプロンプト: 2.3k (1.2%)
  - システムツール: 13.3k (6.7%)
  - メモリファイル: 105 (0.1%)
  - メッセージ: 6.4k (3.2%)
  - 空き容量: 133k (66.4%)

### 備考

- すべてのページで `getCurrentOrg()` / `getCurrentRole()` を呼び出し、コンテキスト表示を実装
- コメントで将来の実装方針（Supabaseセッション、RLS、activity_logs記録）を明記
- CLAUDE_RUNTIME.mdの前提を完全遵守
- 「簡略化」ではなく「正しい分離」を優先

---

## 完了した作業

✅ すべてのファイル生成が完了しました

### 生成されたファイル数
- ルート設定: 4ファイル（package.json, pnpm-workspace.yaml, turbo.json, tsconfig.base.json）
- packages/config: 4ファイル
- packages/db: 3ファイル
- apps/www: 5ファイル（layout.tsx, page.tsx含む）
- apps/app: 7ファイル（dashboard, switch-org含む）
- apps/admin: 9ファイル（overview, members, org-settings含む）
- apps/ops: 5ファイル
- infra/supabase: 1ファイル（schema.sql）
- docs: 3ファイル（README.md, domains.md, spec/tenancy.md）
- ルートファイル: 2ファイル（.env.example, README.md）

**合計: 約43ファイル**

## 今後の作業予定

- [ ] 各アプリの依存関係インストール確認（`pnpm install`）
- [ ] Supabaseプロジェクト作成とschema.sql実行
- [ ] 開発サーバー起動確認（`pnpm dev`）
- [ ] middlewareの実装
- [ ] Server Actionsの実装
- [ ] RLSポリシーの実装
