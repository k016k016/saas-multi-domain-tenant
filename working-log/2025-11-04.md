# 作業ログ 2025-11-04

## E2Eテストのデータ競合問題を解決

### 問題の背景

CI環境でE2Eテストが不安定な状態になっていました。

**症状:**
- ローカル環境: 全テスト成功（安定）
- CI環境: 断続的に失敗（不安定）
- 失敗するテスト: `e2e/tests/p1-baseline/common/cookie-session.spec.ts:51`
  - 期待: member権限のユーザーが `/members` にアクセスすると `/unauthorized` にリダイレクト
  - 実際: 時々 `/members` ページにアクセスできてしまう（admin権限のように振る舞う）

**CI実行結果の例:**
```
Run #19047716313: 25/26 passed (成功)
Run #19048010725: 1/26 passed (失敗)
```

### 根本原因の調査プロセス

#### 初期の試行錯誤

最初は以下のような対症療法を試みていました:

1. **UUIDフォーマット修正** (commit `48071b3`)
   - 問題: PostgreSQLのUUID型に文字列を渡していた
   - 結果: 根本原因ではなかった

2. **テストデータ初期化修正** (commit `0e28ddd`)
   - 問題: テストユーザーが存在しない可能性
   - 結果: 根本原因ではなかった

3. **Next.js静的最適化の無効化** (commit `515543b`)
   - 問題: production buildで `getCurrentRole()` が実行されない可能性
   - 結果: 根本原因ではなかった

4. **ビルドキャッシュクリア** (commit `7e475c6`)
   - 問題: next.config.mjsの変更が反映されていない可能性
   - 結果: **根拠のない推測であり、論理的ではなかった**

この時点でユーザーから重要なフィードバックを受けました:

> **"根拠は？"**
> **"全く論理的じゃない"**
> **"結果は同じだろ？まずはテスト中にデータがどう遷移しているかを丁寧にみてみて"**

#### 証拠ベースの分析

ユーザーの指摘に従い、**実際のデータフロー**を詳しく調査しました。

**1. テスト実行順序の理解**

`playwright.config.ts` を読んで、以下の設定を確認:

```typescript
workers: CI ? 2 : undefined, // CI環境では2並列
```

これにより、CI環境では2つのワーカーで並列実行されることが判明。

**2. テストファイルの詳細分析**

- **Worker 1**: `e2e/tests/p1-baseline/common/cookie-session.spec.ts`
  - `beforeEach`: `resetUserToOrg1(MEMBER.email)` で member1 を org1 (member権限) にリセット
  - テスト: member1 で `/members` にアクセス → `/unauthorized` にリダイレクトされるはず

- **Worker 2**: `e2e/tests/p1-baseline/app/org-switching.spec.ts`
  - テスト: member1 で組織切替を実行 → org2 (admin権限) に切り替える
  - 処理: `user_org_context.org_id` を更新

**3. シードデータの確認**

`infra/supabase/seeds/03_dev_seed.sql` を読んで、member1の所属を確認:

```sql
-- member1は2つの組織に所属
-- org1: role = 'member'
-- org2: role = 'admin'
```

**4. データ競合の発見**

以下のシナリオでデータ競合が発生していることを特定:

1. Worker 1: `resetUserToOrg1()` で member1 を org1 にリセット
2. Worker 1: テスト開始（member1 は org1 で member 権限のはず）
3. **Worker 2**: 並行して組織切替を実行（member1 を org2 に切り替え）
4. Worker 1: `/members` にアクセス → **org2 (admin権限) で判定されてしまう**
5. Worker 1: テスト失敗（期待: リダイレクト、実際: アクセス成功）

**5. `resetUserToOrg1()` の限界**

`e2e/helpers/db.ts` の実装を確認:

```typescript
export async function resetUserToOrg1(email: string): Promise<void> {
  // user_org_context.org_id を org1 に戻す
  await supabase.from('user_org_context').upsert({
    user_id: user.id,
    org_id: TEST_ORG_ID,
  });
}
```

この関数は `beforeEach` で実行されますが、並列実行中の**他のワーカーからの同時更新を防ぐことはできません**。

### 解決策の選択

3つの選択肢を検討しました:

1. **CI環境でworkers=1（直列実行）** ← 採用
2. テストごとに専用ユーザーを用意
3. データベースロック機構の導入

**選択理由:**
- 最もシンプルで確実
- テストデータの複雑化を避ける
- データ競合の根本原因を排除

### 実施した修正

**ファイル:** `playwright.config.ts`

**変更箇所:** 16行目

```typescript
// 変更前:
workers: CI ? 2 : undefined,

// 変更後:
workers: CI ? 1 : undefined, // CI環境では直列実行してテスト間のデータ競合を防ぐ
```

**コミット:**
- `9cef75f` - fix: CI環境でのE2Eテスト並列実行によるデータ競合を解消

### 検証結果

**CI Run:** 19051956582

```
Status: completed
Result: success
Title: fix: CI環境でのE2Eテスト並列実行によるデータ競合を解消
Branch: develop
Execution Time: 4m0s
Date: 2025-11-03T22:59:01Z
```

**テスト結果:**
- ✅ 全26テストが成功
- ✅ データ競合なし（安定した結果）
- ⚠️ 実行時間が約2倍に増加（2m → 4m）

**トレードオフの判断:**
- 実行時間の増加は許容範囲（CI安定性を優先）
- テスト数が増えた場合は、テストグループ分割を検討

### 技術的な学び

#### 1. 証拠ベースのデバッグの重要性

**悪い例（推測ベース）:**
- 「キャッシュが原因かもしれない」→ キャッシュをクリア
- 根拠がなく、問題の本質を見逃す

**良い例（証拠ベース）:**
1. テスト実行ログを詳しく読む
2. テストコードとデータフローを追跡
3. シードデータと実装を照らし合わせる
4. 具体的な競合シナリオを特定
5. 根本原因に対する最小限の修正

#### 2. 並列実行とテスト分離

**Playwrightのワーカー並列実行:**
- 各ワーカーは独立したブラウザコンテキストを持つ
- ただし**データベースは共有**される
- 共有データに依存するテストは競合リスクがある

**テスト分離の原則:**
- 各テストは他のテストと独立して実行できるべき
- 共有データの変更は慎重に扱う
- 並列実行時のデータ競合を考慮する

#### 3. `beforeEach` の限界

**誤解していたこと:**
- `beforeEach` でデータをリセットすれば、テストは常に同じ初期状態から開始されると思っていた

**実際:**
- `beforeEach` は各テストの**開始時**にしか実行されない
- テスト**実行中**の他ワーカーからの変更は防げない
- データベーストランザクション分離とは異なる

#### 4. マルチテナントSaaSのテスト設計

**本プロジェクトの制約:**
- 1ユーザーは複数組織に所属できる
- `user_org_context` でアクティブな組織を管理
- ロールは「ユーザー × 組織」の組み合わせで決まる

**テスト設計の難しさ:**
- 同じユーザーが異なる組織で異なるロールを持つ
- 組織切替のテストとアクセス制御のテストが干渉しあう
- 並列実行時に共有状態の競合が発生しやすい

### 今後の改善案

#### 短期（必要に応じて）
- テストが大幅に増えた場合、テストグループを分割して並列実行を復活
- 例: `test:e2e:group1`, `test:e2e:group2` など、データ依存のないグループに分ける

#### 中期（検討）
- 組織切替テストとアクセス制御テストで別ユーザーを使用
- テストごとに一時的な組織・ユーザーを作成して分離（cleanup必須）

#### 長期（将来）
- テストデータベースのトランザクション分離
- テストごとに独立したデータベーススナップショットを使用

### 参考情報

**関連ファイル:**
- `playwright.config.ts:16` - workers設定
- `e2e/tests/p1-baseline/common/cookie-session.spec.ts:51` - 失敗していたテスト
- `e2e/tests/p1-baseline/app/org-switching.spec.ts` - 競合の原因となったテスト
- `e2e/helpers/db.ts` - resetUserToOrg1() 実装
- `infra/supabase/seeds/03_dev_seed.sql` - member1のデータ定義
- `packages/config/src/auth.ts` - getCurrentRole() 実装
- `apps/admin/app/members/page.tsx` - 権限チェック実装

**CI実行結果:**
- 失敗例: https://github.com/k016k016/saas-multi-domain-tenant/actions/runs/19047716313
- 成功例: https://github.com/k016k016/saas-multi-domain-tenant/actions/runs/19051956582

**コミット:**
- `9cef75f` - fix: CI環境でのE2Eテスト並列実行によるデータ競合を解消

---

## まとめ

この問題の解決を通じて、以下の重要な教訓を得ました:

1. **推測ではなく証拠に基づいてデバッグする**
   - 「〜かもしれない」ではなく「〜であることを確認した」
   - ログ・コード・データを丁寧に追跡する

2. **問題の本質を見抜く**
   - 表面的な症状（テストの失敗）ではなく
   - 根本原因（並列実行によるデータ競合）に対処する

3. **シンプルな解決策を優先する**
   - 複雑なロック機構や専用ユーザーではなく
   - 直列実行という最も確実な方法を選択

4. **トレードオフを理解する**
   - 実行時間の増加を許容
   - テストの安定性を優先
   - 将来の改善余地を残す

ユーザーからの「根拠は？」「全く論理的じゃない」というフィードバックは、エンジニアとして最も重要な姿勢を思い出させてくれました。推測や憶測ではなく、データと証拠に基づいて判断すること。これはテスト修正だけでなく、すべての開発活動に通じる原則です。
