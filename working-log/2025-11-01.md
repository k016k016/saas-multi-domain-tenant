# 作業ログ 2025-11-01

## E2Eテストユーザー不足問題の完全解決

### 問題の背景

- **発生していた問題**: ローカル環境では E2E テストが成功するが、CI 環境で失敗
- **根本原因**: localhost の異なるポート間で Cookie を共有できない
- **二次的問題**: テストユーザーが存在しない場合にE2Eテストが失敗

### 実施した対策

#### 1. Cookie 共有問題の解決

**変更内容:**
- CI 環境の URL を `localhost:PORT` から `.local.test:PORT` に変更
- `/etc/hosts` に `.local.test` ドメインを追加
- `.env.test` で同じドメイン設定を使用

**コミット:**
- `96d4eab` - fix: use .local.test domains in CI for cross-port cookie sharing

**結果:**
- ✅ サブドメイン間で Cookie 共有が可能に
- ✅ ローカル環境と CI 環境で一貫した動作

#### 2. テストユーザー不足問題の解決

**Phase 1: シードスクリプトの修正**

`scripts/seed-test-user.ts` の問題を修正：

1. **UNIQUE constraint 違反の解決** (`da65a5d`)
   - 問題: `profiles` テーブルの `user_id + org_id` 複合キーの競合
   - 解決策: 既存プロファイルを削除してから挿入

2. **admin テストユーザーの追加** (`56ef174`)
   - 問題: `admin1@example.com` が存在せず、4つのテストが失敗
   - 解決策: `TEST_USERS` 配列に admin ユーザーを追加

**Phase 2: 再発防止策の実装**

E2Eテストユーザー不足問題が今後発生しないように、以下を実装：

1. **package.json にセットアップスクリプト追加**
   ```json
   "setup:e2e": "tsx scripts/seed-test-user.ts"
   ```
   - 新規開発者やDB リセット後に手動実行できるコマンド

2. **.env.test.example の作成**
   - 必要な環境変数のテンプレート
   - 新規開発者が設定すべき項目が明確

3. **.gitignore の更新**
   - `.env.test.example` をコミット対象に追加

4. **README.md に E2E テストセクションを追加**
   - 前提条件（Supabase、/etc/hosts 設定）
   - セットアップ手順（環境変数、テストユーザー作成、テスト実行）
   - トラブルシューティング（よくあるエラーと解決策）
   - CI 環境での設定方法

**コミット:**
- `8f9458b` - docs: add E2E test setup documentation and helper script

### テスト結果

#### ローカル環境
```bash
$ pnpm test:e2e
✅ 28 passed (6.3s)
```

#### CI 環境
```
GitHub Actions: Run #18993420188
✅ build-test in 4m23s
✅ 28 passed (30.6s)
```

### 変更ファイル一覧

1. **scripts/seed-test-user.ts**
   - admin テストユーザーを追加
   - UNIQUE constraint 違反を修正

2. **package.json**
   - `setup:e2e` スクリプトを追加

3. **.env.test.example** (新規作成)
   - E2E テスト用環境変数のテンプレート

4. **.gitignore**
   - `.env.test.example` を例外に追加

5. **README.md**
   - E2E テストのセットアップセクションを追加（約150行）

6. **.github/workflows/ci.yml** (前回の変更)
   - `.local.test` ドメインの使用
   - `/etc/hosts` の設定

### 学んだこと

1. **localhost のポート制限**
   - `localhost:3001` と `localhost:3002` は異なる origin として扱われる
   - 同じ origin でなければ Cookie を共有できない
   - サブドメインを使用することで Cookie 共有が可能（`Domain=.local.test`）

2. **E2E テストの再現性**
   - データベース状態に依存するテストは脆弱
   - テストユーザーの自動セットアップが重要
   - CI 環境とローカル環境の一貫性が必須

3. **保守的アプローチの重要性**
   - 自動化よりも明示的なセットアップを優先
   - ドキュメント化とテンプレート提供で問題を予防
   - トラブルシューティングガイドで問題解決を支援

### 次のステップ

現時点で E2E テスト環境は完全に機能しており、新規開発者も簡単にセットアップできる状態になった。

今後の改善案：
- [ ] E2E テスト前に自動的にテストユーザーの存在を確認する仕組み
- [ ] テストデータのクリーンアップスクリプト
- [ ] テスト用組織の自動作成・削除

### 参考リンク

- CI Run: https://github.com/k016k016/saas-multi-domain-tenant/actions/runs/18993420188
- Commit: 8f9458b (docs: add E2E test setup documentation and helper script)
