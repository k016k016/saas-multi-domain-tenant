# 作業ログ 2025-11-01

## E2Eテストユーザー不足問題の完全解決

### 問題の背景

- **発生していた問題**: ローカル環境では E2E テストが成功するが、CI 環境で失敗
- **根本原因**: localhost の異なるポート間で Cookie を共有できない
- **二次的問題**: テストユーザーが存在しない場合にE2Eテストが失敗

### 実施した対策

#### 1. Cookie 共有問題の解決

**変更内容:**
- CI 環境の URL を `localhost:PORT` から `.local.test:PORT` に変更
- `/etc/hosts` に `.local.test` ドメインを追加
- `.env.test` で同じドメイン設定を使用

**コミット:**
- `96d4eab` - fix: use .local.test domains in CI for cross-port cookie sharing

**結果:**
- ✅ サブドメイン間で Cookie 共有が可能に
- ✅ ローカル環境と CI 環境で一貫した動作

#### 2. テストユーザー不足問題の解決

**Phase 1: シードスクリプトの修正**

`scripts/seed-test-user.ts` の問題を修正：

1. **UNIQUE constraint 違反の解決** (`da65a5d`)
   - 問題: `profiles` テーブルの `user_id + org_id` 複合キーの競合
   - 解決策: 既存プロファイルを削除してから挿入

2. **admin テストユーザーの追加** (`56ef174`)
   - 問題: `admin1@example.com` が存在せず、4つのテストが失敗
   - 解決策: `TEST_USERS` 配列に admin ユーザーを追加

**Phase 2: 再発防止策の実装**

E2Eテストユーザー不足問題が今後発生しないように、以下を実装：

1. **package.json にセットアップスクリプト追加**
   ```json
   "setup:e2e": "tsx scripts/seed-test-user.ts"
   ```
   - 新規開発者やDB リセット後に手動実行できるコマンド

2. **.env.test.example の作成**
   - 必要な環境変数のテンプレート
   - 新規開発者が設定すべき項目が明確

3. **.gitignore の更新**
   - `.env.test.example` をコミット対象に追加

4. **README.md に E2E テストセクションを追加**
   - 前提条件（Supabase、/etc/hosts 設定）
   - セットアップ手順（環境変数、テストユーザー作成、テスト実行）
   - トラブルシューティング（よくあるエラーと解決策）
   - CI 環境での設定方法

**コミット:**
- `8f9458b` - docs: add E2E test setup documentation and helper script

### テスト結果

#### ローカル環境
```bash
$ pnpm test:e2e
✅ 28 passed (6.3s)
```

#### CI 環境
```
GitHub Actions: Run #18993420188
✅ build-test in 4m23s
✅ 28 passed (30.6s)
```

### 変更ファイル一覧

1. **scripts/seed-test-user.ts**
   - admin テストユーザーを追加
   - UNIQUE constraint 違反を修正

2. **package.json**
   - `setup:e2e` スクリプトを追加

3. **.env.test.example** (新規作成)
   - E2E テスト用環境変数のテンプレート

4. **.gitignore**
   - `.env.test.example` を例外に追加

5. **README.md**
   - E2E テストのセットアップセクションを追加（約150行）

6. **.github/workflows/ci.yml** (前回の変更)
   - `.local.test` ドメインの使用
   - `/etc/hosts` の設定

### 学んだこと

1. **localhost のポート制限**
   - `localhost:3001` と `localhost:3002` は異なる origin として扱われる
   - 同じ origin でなければ Cookie を共有できない
   - サブドメインを使用することで Cookie 共有が可能（`Domain=.local.test`）

2. **E2E テストの再現性**
   - データベース状態に依存するテストは脆弱
   - テストユーザーの自動セットアップが重要
   - CI 環境とローカル環境の一貫性が必須

3. **保守的アプローチの重要性**
   - 自動化よりも明示的なセットアップを優先
   - ドキュメント化とテンプレート提供で問題を予防
   - トラブルシューティングガイドで問題解決を支援

### 次のステップ

現時点で E2E テスト環境は完全に機能しており、新規開発者も簡単にセットアップできる状態になった。

今後の改善案：
- [ ] E2E テスト前に自動的にテストユーザーの存在を確認する仕組み
- [ ] テストデータのクリーンアップスクリプト
- [ ] テスト用組織の自動作成・削除

### 参考リンク

- CI Run: https://github.com/k016k016/saas-multi-domain-tenant/actions/runs/18993420188
- Commit: 8f9458b (docs: add E2E test setup documentation and helper script)

---

## P1タスク完了 - 管理機能の実装

### 実装した機能

E2Eテスト環境が完全に構築できた後、ロードマップのP1（Priority 1）タスクを実装しました。

#### 1. 監査ログ閲覧UI (`80d5164`)

**実装内容:**
- `apps/admin/app/audit-logs/page.tsx` を新規作成
- 期間フィルタリング機能（1日/7日/30日/90日）
- アクション種別フィルタリング機能
- JSON ペイロードの詳細表示（details/summary）

**技術的ポイント:**
- `getSupabaseAdmin()` を使用して RLS をバイパス
- `packages/db/src/index.ts` に `getSupabaseAdmin()` 関数を追加
- Service Role Key を使用した管理者権限でのデータアクセス
- `activity_logs` テーブルから組織の監査ログを取得

**型エラー修正:**
- `@repo/db/audit` → `@repo/db` へのインポートパス修正
- `org.id` → `org.orgId` へのプロパティ名修正

#### 2. UX最小整備 (`6487649`)

**実装内容:**
- `/unauthorized` ページを4つのアプリに追加
  - `apps/admin/app/unauthorized/page.tsx`
  - `apps/app/app/unauthorized/page.tsx`
  - `apps/ops/app/unauthorized/page.tsx`

- `error.tsx` を4つのアプリに追加
  - `apps/admin/app/error.tsx`
  - `apps/app/app/error.tsx`
  - `apps/ops/app/error.tsx`
  - `apps/www/app/error.tsx`

**既存ページの改善:**
- `apps/admin/app/members/page.tsx`: `notFound()` → `redirect('/unauthorized')`
- `apps/admin/app/audit-logs/page.tsx`: 同様に変更

**効果:**
- 権限不足時に適切な403エラーページを表示
- 予期しないエラー時のユーザー体験向上
- エラー ID（digest）の表示で問題追跡が容易に

#### 3. admin/members 実DB化 (`a6944b6`)

**実装内容:**
- モックデータを削除し、Supabase `profiles` テーブルから実データ取得
- `createServerClient()` を使用して RLS 経由でデータアクセス
- 組織メンバーのみをフィルタリング（`org_id` でフィルタ）

**変更前:**
```typescript
const members = [
  { userId: 'user_owner_123', email: 'owner@example.com', ... },
  // ... モックデータ
];
```

**変更後:**
```typescript
const supabase = await createServerClient();
const { data: profilesData } = await supabase
  .from('profiles')
  .select('user_id, role, created_at')
  .eq('org_id', org.orgId)
  .order('created_at', { ascending: false });

const members = profilesData?.map((profile) => ({
  userId: profile.user_id,
  email: `${profile.user_id.substring(0, 8)}@...`,
  role: profile.role,
  status: 'active' as const,
  createdAt: new Date(profile.created_at).toLocaleDateString('ja-JP'),
})) || [];
```

**制限事項:**
- メールアドレスは `auth.users` テーブルにあり Service Role Key が必要
- 暫定的に `user_id` の一部を表示（将来改善予定）
- `status` カラムは現在のスキーマにないため `'active'` 固定

**型チェック・ビルド:**
- ✅ `pnpm --filter admin typecheck` 成功
- ✅ `pnpm --filter admin build` 成功

### コミット一覧

1. `cefb6c1` - docs: P1タスク計画と作業ログ更新
2. `80d5164` - feat: 監査ログ閲覧UI実装
3. `6487649` - feat: UX最小整備（/unauthorized と error.tsx追加）
4. `a6944b6` - feat: admin/members実DB化 - profilesテーブルからメンバー取得

### 今後の改善予定

**メールアドレス取得の改善:**
- Supabase Admin API を使用して `auth.users` からメールを取得
- または profiles テーブルに email カラムを追加（重複データだが検索性向上）

**ステータス管理の追加:**
- profiles テーブルに `status` カラムを追加
- `'active' | 'pending' | 'inactive'` の状態管理

**監査ログの拡充:**
- メンバー招待時のログ記録
- ロール変更時のログ記録
- メンバー削除時のログ記録
