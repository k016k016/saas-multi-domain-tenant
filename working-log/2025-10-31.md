# 作業ログ: Edge Runtime対応とパッケージクリーンアップ

**日時**: 2025-10-31
**ブランチ**: develop
**作業者**: AI Assistant

## 概要

middlewareでのEdge Runtime互換性問題を解決し、パッケージの整理を実施しました。

## 問題

サーバー起動時に4つのmiddlewareファイルすべてで以下のエラーが発生:

```
Module not found: Can't resolve '@repo/db'
```

**根本原因**: Edge Runtimeでは`@supabase/supabase-js`のようなNode.js依存パッケージをインポートできない。

## 解決策

### 1. Edge-safeパッケージの作成

`@repo/config-edge`パッケージを新規作成:

```
packages/config-edge/
├── package.json
├── tsconfig.json
└── src/
    └── index.ts  # Pure functions only (getDomainFromHost, DOMAINS)
```

- Node.js APIを一切使用しない純粋関数のみ
- TypeScriptソースを直接エクスポート（ビルド不要）

### 2. Next.js設定の追加

全アプリ（www/app/admin/ops）の`next.config.mjs`に追加:

```javascript
transpilePackages: ['@repo/config-edge']
```

### 3. middlewareの軽量化

全middlewareを"Light Gate"パターンに書き換え:

- **www**: 認証済みユーザーをappドメインへリダイレクト
- **app**: Cookie（org_id, role）の存在チェックのみ
- **admin**: memberロールは403、それ以外は要認証チェック
- **ops**: opsロール以外は403

**重要な設計原則**:
- middlewareではDBに一切アクセスしない
- Cookieはhint（信頼しない）として扱う
- 本検証はServer Actions/Route HandlersでNode Runtimeにて実施

### 4. packages/dbのクリーンアップ

誤って追加した以下を削除:
- `createMiddlewareClient`関数
- `createServerClient`のasync化（syncに戻す）
- NextRequest/NextResponse型のインポート

### 5. パッケージクリーンアップ

ルートの`package.json`から未使用パッケージを削除:

```json
// 削除したパッケージ
"@supabase/ssr": "^0.7.0",           // packages/dbのみで使用
"@supabase/supabase-js": "^2.50.0", // packages/dbのみで使用
"pg": "8.16.3"                        // 未使用（psqlはCLI）
```

## テスト結果

### E2Eテスト実行

```bash
pnpm test:e2e
```

**結果**:
- ✅ 8テスト成功: 未認証時のリダイレクト（全ドメイン）
- ❌ 16テスト失敗: ログインページ未実装のためタイムアウト

失敗は想定内（ログインページは次のフェーズ）。

## 変更ファイル一覧

### 新規作成
- `packages/config-edge/package.json`
- `packages/config-edge/tsconfig.json`
- `packages/config-edge/src/index.ts`

### 変更
- `apps/www/middleware.ts` - Edge-safe版に置き換え
- `apps/app/middleware.ts` - Edge-safe版に置き換え
- `apps/admin/middleware.ts` - Edge-safe版に置き換え
- `apps/ops/middleware.ts` - Edge-safe版に置き換え
- `apps/www/next.config.mjs` - transpilePackages追加
- `apps/app/next.config.mjs` - transpilePackages追加
- `apps/admin/next.config.mjs` - transpilePackages追加
- `apps/ops/next.config.mjs` - transpilePackages追加
- `apps/www/package.json` - @repo/config-edge追加
- `apps/app/package.json` - @repo/config-edge追加
- `apps/admin/package.json` - @repo/config-edge追加
- `apps/ops/package.json` - @repo/config-edge追加
- `packages/db/src/index.ts` - 不要な変更を削除
- `package.json` (root) - 未使用dependencies削除

## 技術的学習ポイント

### Edge Runtime vs Node Runtime

- **Edge Runtime**:
  - middlewareで使用
  - Node.js APIは使えない
  - DB接続不可
  - TypeScript直接インポートOK（Edge互換コードなら）

- **Node Runtime**:
  - Server Actions/Route Handlersで使用
  - 完全なNode.js API利用可
  - Supabase + RLSで本検証を実施

### Two-Tier認証アーキテクチャ

1. **Tier 1 (Middleware)**: Cookie存在チェック（untrusted hint）
2. **Tier 2 (Server)**: Supabase + RLS完全検証（trusted）

middlewareは「粗いゲート」、サーバー側で「細かい検証」を行う。

## 次のステップ

1. ログインページ実装（`apps/www/app/www/login/page.tsx`）
2. Supabase Auth + OTP認証フロー
3. Cookie設定（org_id, role）
4. E2Eテストの残り16テストを緑にする

## 参考

- Edge Runtime制約: middlewareではNode依存コードは使えない
- transpilePackages: Next.jsがworkspaceパッケージをEdge用にトランスパイル
- CONTRIBUTING_AI.md: middlewareの削除・統合提案は禁止
