# ä½œæ¥­ãƒ­ã‚°: Edge Runtimeå¯¾å¿œã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

**æ—¥æ™‚**: 2025-10-31
**ãƒ–ãƒ©ãƒ³ãƒ**: develop
**ä½œæ¥­è€…**: AI Assistant

## æ¦‚è¦

middlewareã§ã®Edge Runtimeäº’æ›æ€§å•é¡Œã‚’è§£æ±ºã—ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ•´ç†ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚

## å•é¡Œ

ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«4ã¤ã®middlewareãƒ•ã‚¡ã‚¤ãƒ«ã™ã¹ã¦ã§ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:

```
Module not found: Can't resolve '@repo/db'
```

**æ ¹æœ¬åŸå› **: Edge Runtimeã§ã¯`@supabase/supabase-js`ã®ã‚ˆã†ãªNode.jsä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ããªã„ã€‚

## è§£æ±ºç­–

### 1. Edge-safeãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆ

`@repo/config-edge`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ–°è¦ä½œæˆ:

```
packages/config-edge/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ src/
    â””â”€â”€ index.ts  # Pure functions only (getDomainFromHost, DOMAINS)
```

- Node.js APIã‚’ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ç´”ç²‹é–¢æ•°ã®ã¿
- TypeScriptã‚½ãƒ¼ã‚¹ã‚’ç›´æ¥ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ“ãƒ«ãƒ‰ä¸è¦ï¼‰

### 2. Next.jsè¨­å®šã®è¿½åŠ 

å…¨ã‚¢ãƒ—ãƒªï¼ˆwww/app/admin/opsï¼‰ã®`next.config.mjs`ã«è¿½åŠ :

```javascript
transpilePackages: ['@repo/config-edge']
```

### 3. middlewareã®è»½é‡åŒ–

å…¨middlewareã‚’"Light Gate"ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æ›¸ãæ›ãˆ:

- **www**: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’appãƒ‰ãƒ¡ã‚¤ãƒ³ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- **app**: Cookieï¼ˆorg_id, roleï¼‰ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã®ã¿
- **admin**: memberãƒ­ãƒ¼ãƒ«ã¯403ã€ãã‚Œä»¥å¤–ã¯è¦èªè¨¼ãƒã‚§ãƒƒã‚¯
- **ops**: opsãƒ­ãƒ¼ãƒ«ä»¥å¤–ã¯403

**é‡è¦ãªè¨­è¨ˆåŸå‰‡**:
- middlewareã§ã¯DBã«ä¸€åˆ‡ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„
- Cookieã¯hintï¼ˆä¿¡é ¼ã—ãªã„ï¼‰ã¨ã—ã¦æ‰±ã†
- æœ¬æ¤œè¨¼ã¯Server Actions/Route Handlersã§Node Runtimeã«ã¦å®Ÿæ–½

### 4. packages/dbã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

èª¤ã£ã¦è¿½åŠ ã—ãŸä»¥ä¸‹ã‚’å‰Šé™¤:
- `createMiddlewareClient`é–¢æ•°
- `createServerClient`ã®asyncåŒ–ï¼ˆsyncã«æˆ»ã™ï¼‰
- NextRequest/NextResponseå‹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

### 5. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

ãƒ«ãƒ¼ãƒˆã®`package.json`ã‹ã‚‰æœªä½¿ç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‰Šé™¤:

```json
// å‰Šé™¤ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
"@supabase/ssr": "^0.7.0",           // packages/dbã®ã¿ã§ä½¿ç”¨
"@supabase/supabase-js": "^2.50.0", // packages/dbã®ã¿ã§ä½¿ç”¨
"pg": "8.16.3"                        // æœªä½¿ç”¨ï¼ˆpsqlã¯CLIï¼‰
```

## ãƒ†ã‚¹ãƒˆçµæœ

### E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
pnpm test:e2e
```

**çµæœ**:
- âœ… 8ãƒ†ã‚¹ãƒˆæˆåŠŸ: æœªèªè¨¼æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå…¨ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
- âŒ 16ãƒ†ã‚¹ãƒˆå¤±æ•—: ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸æœªå®Ÿè£…ã®ãŸã‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

å¤±æ•—ã¯æƒ³å®šå†…ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¯æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã€‚

## å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### æ–°è¦ä½œæˆ
- `packages/config-edge/package.json`
- `packages/config-edge/tsconfig.json`
- `packages/config-edge/src/index.ts`

### å¤‰æ›´
- `apps/www/middleware.ts` - Edge-safeç‰ˆã«ç½®ãæ›ãˆ
- `apps/app/middleware.ts` - Edge-safeç‰ˆã«ç½®ãæ›ãˆ
- `apps/admin/middleware.ts` - Edge-safeç‰ˆã«ç½®ãæ›ãˆ
- `apps/ops/middleware.ts` - Edge-safeç‰ˆã«ç½®ãæ›ãˆ
- `apps/www/next.config.mjs` - transpilePackagesè¿½åŠ 
- `apps/app/next.config.mjs` - transpilePackagesè¿½åŠ 
- `apps/admin/next.config.mjs` - transpilePackagesè¿½åŠ 
- `apps/ops/next.config.mjs` - transpilePackagesè¿½åŠ 
- `apps/www/package.json` - @repo/config-edgeè¿½åŠ 
- `apps/app/package.json` - @repo/config-edgeè¿½åŠ 
- `apps/admin/package.json` - @repo/config-edgeè¿½åŠ 
- `apps/ops/package.json` - @repo/config-edgeè¿½åŠ 
- `packages/db/src/index.ts` - ä¸è¦ãªå¤‰æ›´ã‚’å‰Šé™¤
- `package.json` (root) - æœªä½¿ç”¨dependencieså‰Šé™¤

## æŠ€è¡“çš„å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ

### Edge Runtime vs Node Runtime

- **Edge Runtime**:
  - middlewareã§ä½¿ç”¨
  - Node.js APIã¯ä½¿ãˆãªã„
  - DBæ¥ç¶šä¸å¯
  - TypeScriptç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆOKï¼ˆEdgeäº’æ›ã‚³ãƒ¼ãƒ‰ãªã‚‰ï¼‰

- **Node Runtime**:
  - Server Actions/Route Handlersã§ä½¿ç”¨
  - å®Œå…¨ãªNode.js APIåˆ©ç”¨å¯
  - Supabase + RLSã§æœ¬æ¤œè¨¼ã‚’å®Ÿæ–½

### Two-Tierèªè¨¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

1. **Tier 1 (Middleware)**: Cookieå­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆuntrusted hintï¼‰
2. **Tier 2 (Server)**: Supabase + RLSå®Œå…¨æ¤œè¨¼ï¼ˆtrustedï¼‰

middlewareã¯ã€Œç²—ã„ã‚²ãƒ¼ãƒˆã€ã€ã‚µãƒ¼ãƒãƒ¼å´ã§ã€Œç´°ã‹ã„æ¤œè¨¼ã€ã‚’è¡Œã†ã€‚

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å®Ÿè£…ï¼ˆ`apps/www/app/www/login/page.tsx`ï¼‰
2. Supabase Auth + OTPèªè¨¼ãƒ•ãƒ­ãƒ¼
3. Cookieè¨­å®šï¼ˆorg_id, roleï¼‰
4. E2Eãƒ†ã‚¹ãƒˆã®æ®‹ã‚Š16ãƒ†ã‚¹ãƒˆã‚’ç·‘ã«ã™ã‚‹

## å‚è€ƒ

- Edge Runtimeåˆ¶ç´„: middlewareã§ã¯Nodeä¾å­˜ã‚³ãƒ¼ãƒ‰ã¯ä½¿ãˆãªã„
- transpilePackages: Next.jsãŒworkspaceãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’Edgeç”¨ã«ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«
- CONTRIBUTING_AI.md: middlewareã®å‰Šé™¤ãƒ»çµ±åˆææ¡ˆã¯ç¦æ­¢

---

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ

**æ—¥æ™‚**: 2025-10-31 (åŒæ—¥å¤œé–“)
**é‡è¦åº¦**: ğŸš¨ Critical

## ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ¦‚è¦

GitHubã‚ˆã‚Š`.env.test`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å—ä¿¡ã€‚

**å½±éŸ¿ç¯„å›²**:
- Supabase Anon Keyï¼ˆå…¬é–‹OKã€å½±éŸ¿å°ï¼‰
- **Supabase Service Role Key**ï¼ˆç®¡ç†è€…æ¨©é™ã€å½±éŸ¿å¤§ï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ï¼ˆç›´æ¥DBæ¥ç¶šå¯èƒ½ã€å½±éŸ¿å¤§ï¼‰

## å¯¾å¿œå†…å®¹

### 1. Gitå±¥æ­´ã‹ã‚‰ã®å®Œå…¨å‰Šé™¤

`.env.test`ã‚’Gitå±¥æ­´å…¨ä½“ã‹ã‚‰å‰Šé™¤:

```bash
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch .env.test" \
  --prune-empty --tag-name-filter cat -- --all

git push origin --force --all
git gc --prune=now --aggressive
```

### 2. .gitignoreã¸ã®è¿½åŠ 

`.gitignore`ã«`.env.test`ã‚’è¿½åŠ ã—ã€ä»Šå¾Œã®ã‚³ãƒŸãƒƒãƒˆã‚’é˜²æ­¢ã€‚

### 3. èªè¨¼æƒ…å ±ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´

- Supabase Dashboardã‹ã‚‰DBãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†ç”Ÿæˆ
- æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆPostgreSQL 17.6ï¼‰

#### Supabase APIã‚­ãƒ¼ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

##### Anon Keyï¼ˆæ–°è¦ç™ºè¡Œï¼‰
- ç™ºè¡Œæ—¥æ™‚: 2025-10-31 00:58:10 UTC
- `role`: "anon"
- JWTãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®`iat`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ–°è¦ç™ºè¡Œã‚’ç¢ºèª

##### Service Role Keyï¼ˆæ–°è¦ç™ºè¡Œï¼‰
- ç™ºè¡Œæ—¥æ™‚: 2025-10-31 00:58:10 UTC
- `role`: "service_role"
- JWTãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®`iat`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ–°è¦ç™ºè¡Œã‚’ç¢ºèª

**æ¤œè¨¼æ–¹æ³•**: JWTã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦`iat`ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ–°ã—ã„ã“ã¨ã‚’ç¢ºèªã€‚

### 4. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°

`.env.test`ã‚’æ–°ã—ã„èªè¨¼æƒ…å ±ã§æ›´æ–°ï¼ˆGitç®¡ç†å¤–ï¼‰ã€‚

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: Service Role KeyãŒé‡è¤‡

**ç¾è±¡**: æä¾›ã•ã‚ŒãŸService Role Keyã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨Anon Keyã¨åŒã˜å†…å®¹ã€‚

**åŸå› **: æ‰‹å‹•ã‚³ãƒ”ãƒ¼æ™‚ã«Anon Keyã‚’2å›è²¼ã‚Šä»˜ã‘ã€‚

**è§£æ±º**: JWT payloadã®`role`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèªã—ã€æ­£ã—ã„Service Role Keyã‚’å†å–å¾—ã€‚

### å•é¡Œ2: Supabase CLIèªè¨¼å¤±æ•—

**ç¾è±¡**: `supabase login`ãŒéTTYç’°å¢ƒã§ãƒ–ãƒ©ã‚¦ã‚¶èªè¨¼ä¸å¯ã€‚

**è©¦è¡Œ**: `--token`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒˆãƒ¼ã‚¯ãƒ³æ¸¡ã—ã‚’è©¦ã¿ã‚‹ã‚‚ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã€‚

**è§£æ±º**: Supabase Dashboardã‹ã‚‰æ‰‹å‹•ã§APIã‚­ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€‚

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- âœ… `.env.test`ã‚’Gitå±¥æ­´ã‹ã‚‰å®Œå…¨å‰Šé™¤
- âœ… `.gitignore`ã«`.env.test`ã‚’è¿½åŠ 
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ»æ¤œè¨¼
- âœ… Supabase Anon Keyæ–°è¦ç™ºè¡Œãƒ»æ¤œè¨¼
- âœ… Supabase Service Role Keyæ–°è¦ç™ºè¡Œãƒ»æ¤œè¨¼
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«`.env.test`ã‚’æ–°èªè¨¼æƒ…å ±ã§æ›´æ–°
- âœ… ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¸force pushå®Œäº†

## ä»Šå¾Œã®äºˆé˜²ç­–

1. `.env.test`ã¯çµ¶å¯¾ã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼ˆ.gitignoreã§ä¿è­·æ¸ˆã¿ï¼‰
2. èªè¨¼æƒ…å ±ã¯ç’°å¢ƒå¤‰æ•°ã®ã¿ã§ç®¡ç†
3. pre-commitãƒ•ãƒƒã‚¯ã§ã®æ©Ÿå¯†æƒ…å ±æ¤œå‡ºã‚’æ¤œè¨
4. Supabaseã®RLSï¼ˆRow Level Securityï¼‰ã§æœ€å°æ¨©é™ã®åŸå‰‡ã‚’å¾¹åº•

## å‚è€ƒè³‡æ–™

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- Git filter-branch: Gitå±¥æ­´ã‹ã‚‰æ©Ÿå¯†æƒ…å ±ã‚’å‰Šé™¤ã™ã‚‹å…¬å¼ãƒ„ãƒ¼ãƒ«
- JWT Structure: Header.Payload.Signatureå½¢å¼ã€Payloadã«role/iat/expã‚’å«ã‚€
