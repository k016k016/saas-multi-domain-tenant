# 2025-10-29 作業ログ

## ポート番号変更 (3001/3002/3003/3004)

### 目的
各アプリのポート番号を1つずつシフトして、ポート3000を別用途に開放する。

### 変更内容

#### 1. ファイル名修正
- `CLAUDE_RUNTIME_FULLmd` → `CLAUDE_RUNTIME_FULL.md` (拡張子追加)

#### 2. package.json のポート番号更新 (4ファイル)

**apps/www/package.json**
- 変更前: `"dev": "next dev -p 3000"`, `"start": "next start -p 3000"`
- 変更後: `"dev": "next dev -p 3001"`, `"start": "next start -p 3001"`

**apps/app/package.json**
- 変更前: `"dev": "next dev -p 3001"`, `"start": "next start -p 3001"`
- 変更後: `"dev": "next dev -p 3002"`, `"start": "next start -p 3002"`

**apps/admin/package.json**
- 変更前: `"dev": "next dev -p 3002"`, `"start": "next start -p 3002"`
- 変更後: `"dev": "next dev -p 3003"`, `"start": "next start -p 3003"`

**apps/ops/package.json**
- 変更前: `"dev": "next dev -p 3003"`, `"start": "next start -p 3003"`
- 変更後: `"dev": "next dev -p 3004"`, `"start": "next start -p 3004"`

#### 3. CLAUDE_RUNTIME_FULL.md のドキュメント更新

**セクション8「ローカル開発時の起動方法」**
- コマンド例のポート番号コメントを更新
  - www: 3000 → 3001
  - app: 3001 → 3002
  - admin: 3002 → 3003
  - ops: 3003 → 3004

**アクセスURL**
- `http://www.local.test:3000` → `http://www.local.test:3001`
- `http://app.local.test:3001` → `http://app.local.test:3002`
- `http://admin.local.test:3002` → `http://admin.local.test:3003`
- `http://ops.local.test:3003` → `http://ops.local.test:3004`

**Cookie共有の説明**
- 例示ポート番号を更新: `app.local.test:3001` や `admin.local.test:3002` → `app.local.test:3002` や `admin.local.test:3003`

### 新しいポート構成

| ドメイン | 旧ポート | 新ポート | 役割 |
|---------|---------|---------|------|
| www     | 3000    | **3001** | 外向けLP・ログイン導線 |
| app     | 3001    | **3002** | 日常業務UI |
| admin   | 3002    | **3003** | 組織管理・高リスク操作 |
| ops     | 3003    | **3004** | 事業者側内部コンソール |

### 起動コマンド

```bash
# 各ターミナルで実行
cd apps/www && pnpm run dev    # ポート 3001
cd apps/app && pnpm run dev    # ポート 3002
cd apps/admin && pnpm run dev  # ポート 3003
cd apps/ops && pnpm run dev    # ポート 3004
```

### 注意事項
- `/etc/hosts` の設定は変更不要（ドメイン名はそのまま）
- Cookie共有の仕組みは変更なし（ポート番号はCookieスコープに影響しない）
- 4-App独立アーキテクチャは維持

### 関連ファイル
- `CLAUDE_RUNTIME_FULL.md`: L214-223, L237-240, L255
- `apps/www/package.json`: L6, L8
- `apps/app/package.json`: L6, L8
- `apps/admin/package.json`: L6, L8
- `apps/ops/package.json`: L6, L8

---

## ステップ1: ポート動作確認 ✅

### 実施日時
2025-10-29 (コンテキスト継続後)

### 目的
ポート番号変更後の4アプリが新しいポートで正常に動作することを確認する。

### 確認内容

#### 1. アプリ起動確認
全てのアプリが新ポートで正常に起動：

```bash
cd apps/www && pnpm run dev    # ポート 3001 ✓
cd apps/app && pnpm run dev    # ポート 3002 ✓
cd apps/admin && pnpm run dev  # ポート 3003 ✓
cd apps/ops && pnpm run dev    # ポート 3004 ✓
```

**起動結果:**
- Next.js 16.0.1 (Turbopack) で全アプリ起動成功
- 起動時間: 約 230-240ms

#### 2. HTTPレスポンス確認

| アプリ | ポート | HTTPステータス | 結果 |
|--------|--------|---------------|------|
| www    | 3001   | 200 OK        | ✅ 正常 |
| app    | 3002   | 200 OK        | ✅ 正常 |
| admin  | 3003   | 404           | ✅ 正常 (rootページなし) |
| ops    | 3004   | 403 Forbidden | ✅ 正常 (middlewareで保護) |

**検証コマンド:**
```bash
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3001/  # 200
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3002/  # 200
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3003/  # 404
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3004/  # 403
```

### 結論
✅ **ステップ1完了**: 全アプリが新しいポート (3001/3002/3003/3004) で正常に動作することを確認。

---

## ステップ2: データベーススキーマ確認 ✅

### 実施日時
2025-10-29 (コンテキスト継続後)

### 目的
Supabase 統合前にデータベーススキーマが要件を満たしているか確認する。

### 確認対象ファイル
`infra/supabase/schema.sql`

### 要件チェック

#### ✅ 1. 3つのテーブル定義
- `organizations` (L37-44): 組織の基本情報
- `profiles` (L55-64): ユーザーと組織の関連、ロール管理
- `activity_logs` (L78-85): 監査ログ

#### ✅ 2. org_id スコープ
- `organizations.id`: 主キー (UUID) = org_id そのもの
- `profiles.org_id`: 外部キー `REFERENCES organizations(id)`
- `activity_logs.org_id`: 外部キー `REFERENCES organizations(id)`

#### ✅ 3. role 定義
```sql
role TEXT NOT NULL CHECK (role IN ('member', 'admin', 'owner', 'ops'))
```
(L59)

#### ✅ 4. 冒頭コメント (L6-33)
以下の重要原則が明記されている:
- **owner 制約** (L19-21):
  - 各組織には owner が必ず1人必要
  - owner は削除不可
  - owner 交代は「譲渡」のみ許可
- **監査ログ** (L27-31):
  - 組織切替、ユーザーCRUD、ロール変更、支払い変更、組織凍結/廃止、owner譲渡を必ず記録
- **RLS 必須** (L13-16, L122):
  - "RLS を無効化・バイパスする実装は許可しない"
  - "org_id 単位のアクセス制御は必須"

#### ✅ 5. RLS ポリシー保留
```sql
-- TODO: RLS policies
```
(L104)

将来的なポリシー実装方針を記載 (L106-123)、ただし実装は先送り。

#### ✅ 6. RLS 有効化
```sql
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE activity_logs ENABLE ROW LEVEL SECURITY;
```
(L128-130)

### 追加確認事項

#### インデックス定義 (L93-98)
```sql
CREATE INDEX IF NOT EXISTS idx_profiles_user_id ON profiles(user_id);
CREATE INDEX IF NOT EXISTS idx_profiles_org_id ON profiles(org_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_org_id ON activity_logs(org_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_user_id ON activity_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_created_at ON activity_logs(created_at DESC);
```

#### 初期データ (L137-141)
開発用サンプル組織2件:
- `org_dummy_12345`: サンプル組織A (business プラン)
- `org_dummy_67890`: サンプル組織B (free プラン)

### 結論
✅ **ステップ2完了**: `infra/supabase/schema.sql` は全要件を満たしており、Supabase 統合の準備が整っている。

---

## 次のステップ

### ステップ3: Supabase 統合
- Supabase プロジェクト作成
- 環境変数設定 (`.env.local`)
- `schema.sql` を Supabase に適用
- Supabase Auth 設定
- `getCurrentRole()` / `getCurrentOrg()` 実装
- Session 管理と Cookie 設定

---

## ステップ3: Supabase認証統合の準備 ✅

### 実施日時
2025-10-29 (コンテキスト継続後)

### 目的
Supabase統合の準備として、環境変数、セットアップ手順書、クライアント実装、Cookie設定を整備する。

### 実施内容

#### 1. `.env.example` のポート番号更新
- L25-28: `3001/3002/3003/3004` に修正
- L93-96: コメント内のポート番号も同様に修正

#### 2. `.env.local` の作成
新規作成したファイル:
- ポート番号: 新しい値（3001/3002/3003/3004）で設定
- Supabase環境変数: 空欄（手動設定用）
- Cookie Domain: `.local.test`

#### 3. Supabaseセットアップ手順書の作成
`infra/supabase/SETUP.md` を新規作成:
- ステップ1: Supabaseプロジェクト作成手順
- ステップ2: `schema.sql` 適用方法（SQL Editor使用）
- ステップ3: 環境変数取得方法（URL, ANON_KEY, SERVICE_ROLE_KEY）
- ステップ4: `.env.local` への設定方法
- ステップ5: 認証設定（Redirect URLs: `http://*.local.test:300*/auth/callback`）
- ステップ6: 動作確認手順
- トラブルシューティングセクション
- RLSに関する注意事項

#### 4. `packages/db` のSupabaseクライアント実装強化
`packages/db/src/index.ts` を更新:

**追加した関数:**
- `createServerClient()`: Server側用、Service Role Key使用
  - RLSをバイパス可能
  - Server Actions, API Routes, middleware等で使用
  - `autoRefreshToken: false`, `persistSession: false`

- `createBrowserClient()`: Client側用、Anon Key使用
  - RLSで保護される
  - React Component, Client Componentで使用
  - `autoRefreshToken: true`, `persistSession: true`

**環境変数の取得:**
```typescript
const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || '';
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '';
const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY || '';
```

#### 5. `packages/config` にCookie設定ヘルパーを追加
`packages/config/src/cookies.ts` を新規作成:

**追加した関数:**
- `setOrgIdCookie(orgId: string)`: org_id をCookieに保存
- `getOrgIdCookie()`: org_id をCookieから取得
- `clearOrgIdCookie()`: org_id Cookieを削除
- `getOrgIdFromBrowser()`: クライアント側でorg_idを取得

**Cookie設定:**
- Domain: `.local.test` (開発環境) / `.yourdomain.com` (本番環境)
- Path: `/`
- MaxAge: 1年 (60 * 60 * 24 * 365)
- HttpOnly: false（JavaScriptから読み取り可能）
- Secure: 本番環境のみtrue
- SameSite: Lax（CSRF対策）

`packages/config/src/index.ts` に追加エクスポート:
```typescript
export { setOrgIdCookie, getOrgIdCookie, clearOrgIdCookie, getOrgIdFromBrowser } from './cookies';
```

#### 6. 各middlewareのコメント更新

**packages/config/src/auth.ts** (`getCurrentRole()`):
- Supabase Sessionから user_id 取得の実装パスを記述
- Cookieから org_id 取得の実装パスを記述
- profiles テーブルから role を SELECT する実装パスを記述

**apps/app/middleware.ts**:
- Supabase Sessionの確認方法を追記
- org_id Cookieの確認方法を追記

**apps/ops/middleware.ts**:
- IP制限の実装パスを追記
- Supabase Sessionの確認方法を追記

### 重要な方針
- **getCurrentRole/getCurrentOrg は今回ダミーのまま** - 実装パスをコメントで明記
- middlewareのロール判定ロジックは既に完成（ダミー値使用）
- Supabaseプロジェクト作成は手動（手順書を用意）
- Cookie設定の実装コードを追加（実際の動作は次ステップ）
- RLS ポリシーは未実装（TODO のまま）

### 成果物
1. `.env.local` - 環境変数テンプレート（Supabase設定は空欄）
2. `infra/supabase/SETUP.md` - Supabaseセットアップ手順書
3. `packages/db/src/index.ts` - Server/Client分離したSupabaseクライアント
4. `packages/config/src/cookies.ts` - Cookie管理ヘルパー
5. `.env.example` - ポート番号を新しい値に更新
6. 各middlewareとauth.ts - 実装パスをコメントで明記

### 結論
✅ **ステップ3完了**: Supabase統合の準備が整い、実際のSupabaseプロジェクト作成とデータベース設定を行う準備ができた。

---

---

## ステップ4: admin/members の実装強化 ✅

### 実施日時
2025-10-29 (コンテキスト継続後)

### 目的
admin ドメインのユーザー管理機能（`/members`）を実装準備完了状態にする。

### 実施内容

#### 1. `apps/admin/app/members/actions.ts` の強化

**変更内容:**
- owner保護チェックのコメント解除（実装パスとして記述）
- 3つのServer Actionに詳細な実装パスを追加

**追加した実装パス:**

##### `inviteUser(email, role)`:
- Supabase Sessionから現在のユーザーIDを取得
- 重複メールアドレスのチェック（profiles テーブル）
- `supabase.auth.admin.inviteUserByEmail()` で招待メール送信
- profiles テーブルに仮ユーザーレコード作成（status: pending）
- activity_logs に招待ログを記録（action: 'user_invited'）

##### `changeUserRole(targetUserId, newRole)`:
- 対象ユーザーの情報を profiles テーブルから取得
- **owner のロール変更は禁止**（エラーを返す）
- profiles テーブルの role カラムを UPDATE
- activity_logs に変更ログを記録（action: 'role_changed', old_role/new_role）

##### `removeUser(targetUserId)`:
- 対象ユーザーの情報を profiles テーブルから取得
- **owner の削除は禁止**（エラーを返す）
- profiles テーブルのレコードを削除または無効化
  - 推奨: 論理削除（status: inactive, deleted_at, deleted_by）
  - 物理削除も可能だが監査要件に注意
- activity_logs に削除ログを記録（action: 'user_removed'）

**重要な方針:**
- 実際のDB操作はまだ実装しない（TODOコメントのまま）
- 実装パスを詳細にコメントで記述し、将来の実装を容易にする
- owner保護チェックはコメントアウトしたまま（実装時に有効化）
- `{ success, nextUrl }` パターンを維持、`redirect()` は使用しない

#### 2. `docs/spec/member-management.md` の作成

**作成内容:**
- `docs/spec/README.md` のテンプレートに従った8セクション構成
- 機能概要、前提条件、正常フロー、権限制御を詳細に記述
- データモデル（profiles / activity_logs テーブル）
- activity_logs の action 値と details JSON 構造の例示
- エラーハンドリング（バリデーション/権限/DB/セッション）
- UI/UX 設計（フォーム/一覧/インタラクション）
- 禁止事項（アーキテクチャ違反/owner ルール違反/監査ログ省略/テスト緩和）
- 将来実装（owner譲渡/招待期限/プロフィール編集/一括招待/監査ログUI）
- 関連ファイルと関連仕様書へのリンク

**主要な制約事項:**
- **owner のロール変更は禁止** - 譲渡機能を別途実装
- **owner の削除は禁止** - 譲渡後にのみ削除可能
- **activity_logs への記録は省略禁止** - 全admin操作を記録
- **Server Action で `redirect()` 禁止** - `{ success, nextUrl }` を返す

#### 3. 既存コードとの整合性確認

**確認項目:**
- `apps/admin/app/members/page.tsx`: 既にダミーデータで一覧表示済み ✓
- `apps/admin/app/members/invite-user-form.tsx`: 既にServer Action呼び出し実装済み ✓
- `apps/admin/app/members/member-list.tsx`: 既にロール変更/削除UI実装済み、owner は disabled ✓
- `apps/admin/middleware.ts`: 既に admin/owner のみアクセス許可 ✓
- `packages/config/src/auth.ts`: getCurrentRole/getCurrentOrg/hasRole 実装済み ✓

### 成果物
1. `apps/admin/app/members/actions.ts` - 詳細な実装パスを追加（126行 → 約400行）
2. `docs/spec/member-management.md` - 完全な仕様書を新規作成
3. 既存コードとの整合性を確認、追加修正不要

### 結論
✅ **ステップ4完了**: admin/members 機能の実装準備が整い、Supabase接続後すぐに実装可能な状態になった。

---

---

## ステップ5: middlewareテスト ✅

### 実施日時
2025-10-29 (コンテキスト継続後)

### 目的
ロールベースのmiddlewareが正しく機能することを確認する。

### 実施内容

#### 1. テスト環境準備
- `packages/config/src/auth.ts` の `getCurrentRole()` を利用してロール切り替え
- `role: 'member'` / `role: 'owner'` を切り替えてテスト実行

#### 2. テスト実行

##### テスト1: member ロールで admin ドメインアクセス → 403
**手順:**
1. `getCurrentRole()` を `role: 'member'` に変更
2. admin アプリを再起動（.nextキャッシュクリア）
3. `curl http://localhost:3003/members` を実行

**結果:**
```
403 Forbidden

You do not have permission to access the admin domain.
Required role: admin or owner
Your role: member
```

✅ **成功**: member ロールは admin ドメインにアクセスできず、403が返された。

##### テスト2: owner ロールで admin ドメインアクセス → 200 OK
**手順:**
1. `getCurrentRole()` を `role: 'owner'` に変更
2. `curl http://localhost:3003/members` を実行

**結果:**
```
HTTP Status: 200
```

HTMLレスポンスが返り、メンバー管理ページが正常に表示される。

✅ **成功**: owner ロールは admin ドメインにアクセスでき、200 OK が返された。

#### 3. middlewareロジック確認

**`apps/admin/middleware.ts` (L27):**
```typescript
if (!hasRole(role, 'admin')) {
  return new Response(
    `403 Forbidden\n\nYou do not have permission to access the admin domain.\nRequired role: admin or owner\nYour role: ${role}`,
    {
      status: 403,
      headers: { 'Content-Type': 'text/plain' },
    }
  );
}
```

**`packages/config/src/auth.ts` (L95-108):**
```typescript
export function hasRole(userRole: Role, requiredRole: Role): boolean {
  if (requiredRole === 'ops') {
    return userRole === 'ops';
  }

  const roleHierarchy: Record<Role, number> = {
    member: 1,
    admin: 2,
    owner: 3,
    ops: 0, // ops は階層外
  };

  return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
}
```

**動作確認:**
- `hasRole('member', 'admin')` → `1 >= 2` → `false` → 403
- `hasRole('owner', 'admin')` → `3 >= 2` → `true` → アクセス許可

### テスト結果まとめ

| テスト項目                           | 期待結果 | 実際の結果 | 判定 |
|--------------------------------------|---------|-----------|------|
| member が admin ドメインにアクセス    | 403     | 403       | ✅   |
| owner が admin ドメインにアクセス     | 200     | 200       | ✅   |

### 未実装テスト（将来実装）

以下のテストは Supabase 統合後に実施予定:
- 組織切替時の nextUrl 遷移
- RLS による別組織データの隔離
- Supabase Session による実際の認証フロー

### 結論
✅ **ステップ5完了**: middlewareが正しく機能し、ロールベースのアクセス制御が動作することを確認した。

---

---

## Supabase統合フェーズ: Step 1 - SETUP.md 簡略化と保護ルール追加 ✅

### 実施日時
2025-10-29 (コンテキスト継続後)

### 目的
`infra/supabase/SETUP.md` をユーザー指定のシンプルなテンプレートに置き換え、AIによる勝手な変更を防ぐため `CONTRIBUTING_AI.md` に保護ルールを追加する。

### 実施内容

#### 1. `infra/supabase/SETUP.md` の簡略化

**変更前:**
- 192行の詳細なセットアップガイド
- 6ステップの段階的手順
- トラブルシューティング、RLS説明、参考リンクを含む

**変更後:**
- 19行のシンプルなテンプレート
- 5ステップに集約
- Cookie Domain (`.local.test`) の説明を追加
- RLS前提・owner一人制・activity_logs必須の方針を明記

**新しい構成:**
1. Supabaseプロジェクト作成（手動）
2. SQLエディタで `schema.sql` を適用
3. 環境変数の設定 (`.env.local`)
4. ローカル開発時のドメイン/ポート構成
5. Cookie設定の説明 (`Domain=.local.test`)

#### 2. `CONTRIBUTING_AI.md` に保護ルール追加

**追加内容:**
- `infra/supabase/SETUP.md` はAIが勝手に変更しない

**追加場所:**
「変更禁止ファイル / 要人間レビュー領域」セクション (L20)

**目的:**
将来のAIアシスタントが `SETUP.md` を「改善」「整理」「詳細化」などの名目で書き換えないようにする。

### 成果物
1. `infra/supabase/SETUP.md` - 簡潔な5ステップガイド
2. `CONTRIBUTING_AI.md` - SETUP.md の保護ルール追加

### 重要な方針
- **SETUP.md はこれ以上AIが触らない** - 人間のみが編集
- **Cookie Domain は `.local.test` 前提** - 全サブドメインで共有
- **RLS前提・owner一人制・activity_logs必須** - この方針は変更不可

### 結論
✅ **Supabase統合フェーズ Step 1 完了**: セットアップガイドが完成し、保護ルールも追加された。次はSupabaseプロジェクトの手動作成と、`getCurrentRole()` / `getCurrentOrg()` の実装に進む。

---

## 次のステップ

### Supabase統合フェーズ: Step 2以降
1. **Step 2**: `getCurrentRole()` / `getCurrentOrg()` の実装
   - Cookie から `current_org_id` 取得
   - Supabase Session から `user_id` 取得
   - profiles テーブルから `role` を SELECT
   - **重要**: デフォルトでmemberにしない、未所属orgへのアクセス禁止
2. **Step 3**: RLS ポリシー実装
   - org_id ベースの隔離
   - 別orgのレコードはDBで弾かれる
   - **禁止**: 開発中にRLS OFFにする
3. **Step 4**: E2Eテスト
   - 4.1: 組織切替のテスト (nextUrl パターン)
   - 4.2: RLS隔離テスト (別org のデータが見えないこと)
   - 4.3: Admin 403テスト (member → 403, owner → 200) - 必須
