# 2025-10-29 作業ログ

## ポート番号変更 (3001/3002/3003/3004)

### 目的
各アプリのポート番号を1つずつシフトして、ポート3000を別用途に開放する。

### 変更内容

#### 1. ファイル名修正
- `CLAUDE_RUNTIME_FULLmd` → `CLAUDE_RUNTIME_FULL.md` (拡張子追加)

#### 2. package.json のポート番号更新 (4ファイル)

**apps/www/package.json**
- 変更前: `"dev": "next dev -p 3000"`, `"start": "next start -p 3000"`
- 変更後: `"dev": "next dev -p 3001"`, `"start": "next start -p 3001"`

**apps/app/package.json**
- 変更前: `"dev": "next dev -p 3001"`, `"start": "next start -p 3001"`
- 変更後: `"dev": "next dev -p 3002"`, `"start": "next start -p 3002"`

**apps/admin/package.json**
- 変更前: `"dev": "next dev -p 3002"`, `"start": "next start -p 3002"`
- 変更後: `"dev": "next dev -p 3003"`, `"start": "next start -p 3003"`

**apps/ops/package.json**
- 変更前: `"dev": "next dev -p 3003"`, `"start": "next start -p 3003"`
- 変更後: `"dev": "next dev -p 3004"`, `"start": "next start -p 3004"`

#### 3. CLAUDE_RUNTIME_FULL.md のドキュメント更新

**セクション8「ローカル開発時の起動方法」**
- コマンド例のポート番号コメントを更新
  - www: 3000 → 3001
  - app: 3001 → 3002
  - admin: 3002 → 3003
  - ops: 3003 → 3004

**アクセスURL**
- `http://www.local.test:3000` → `http://www.local.test:3001`
- `http://app.local.test:3001` → `http://app.local.test:3002`
- `http://admin.local.test:3002` → `http://admin.local.test:3003`
- `http://ops.local.test:3003` → `http://ops.local.test:3004`

**Cookie共有の説明**
- 例示ポート番号を更新: `app.local.test:3001` や `admin.local.test:3002` → `app.local.test:3002` や `admin.local.test:3003`

### 新しいポート構成

| ドメイン | 旧ポート | 新ポート | 役割 |
|---------|---------|---------|------|
| www     | 3000    | **3001** | 外向けLP・ログイン導線 |
| app     | 3001    | **3002** | 日常業務UI |
| admin   | 3002    | **3003** | 組織管理・高リスク操作 |
| ops     | 3003    | **3004** | 事業者側内部コンソール |

### 起動コマンド

```bash
# 各ターミナルで実行
cd apps/www && pnpm run dev    # ポート 3001
cd apps/app && pnpm run dev    # ポート 3002
cd apps/admin && pnpm run dev  # ポート 3003
cd apps/ops && pnpm run dev    # ポート 3004
```

### 注意事項
- `/etc/hosts` の設定は変更不要（ドメイン名はそのまま）
- Cookie共有の仕組みは変更なし（ポート番号はCookieスコープに影響しない）
- 4-App独立アーキテクチャは維持

### 関連ファイル
- `CLAUDE_RUNTIME_FULL.md`: L214-223, L237-240, L255
- `apps/www/package.json`: L6, L8
- `apps/app/package.json`: L6, L8
- `apps/admin/package.json`: L6, L8
- `apps/ops/package.json`: L6, L8

---

## ステップ1: ポート動作確認 ✅

### 実施日時
2025-10-29 (コンテキスト継続後)

### 目的
ポート番号変更後の4アプリが新しいポートで正常に動作することを確認する。

### 確認内容

#### 1. アプリ起動確認
全てのアプリが新ポートで正常に起動：

```bash
cd apps/www && pnpm run dev    # ポート 3001 ✓
cd apps/app && pnpm run dev    # ポート 3002 ✓
cd apps/admin && pnpm run dev  # ポート 3003 ✓
cd apps/ops && pnpm run dev    # ポート 3004 ✓
```

**起動結果:**
- Next.js 16.0.1 (Turbopack) で全アプリ起動成功
- 起動時間: 約 230-240ms

#### 2. HTTPレスポンス確認

| アプリ | ポート | HTTPステータス | 結果 |
|--------|--------|---------------|------|
| www    | 3001   | 200 OK        | ✅ 正常 |
| app    | 3002   | 200 OK        | ✅ 正常 |
| admin  | 3003   | 404           | ✅ 正常 (rootページなし) |
| ops    | 3004   | 403 Forbidden | ✅ 正常 (middlewareで保護) |

**検証コマンド:**
```bash
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3001/  # 200
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3002/  # 200
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3003/  # 404
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3004/  # 403
```

### 結論
✅ **ステップ1完了**: 全アプリが新しいポート (3001/3002/3003/3004) で正常に動作することを確認。

---

## ステップ2: データベーススキーマ確認 ✅

### 実施日時
2025-10-29 (コンテキスト継続後)

### 目的
Supabase 統合前にデータベーススキーマが要件を満たしているか確認する。

### 確認対象ファイル
`infra/supabase/schema.sql`

### 要件チェック

#### ✅ 1. 3つのテーブル定義
- `organizations` (L37-44): 組織の基本情報
- `profiles` (L55-64): ユーザーと組織の関連、ロール管理
- `activity_logs` (L78-85): 監査ログ

#### ✅ 2. org_id スコープ
- `organizations.id`: 主キー (UUID) = org_id そのもの
- `profiles.org_id`: 外部キー `REFERENCES organizations(id)`
- `activity_logs.org_id`: 外部キー `REFERENCES organizations(id)`

#### ✅ 3. role 定義
```sql
role TEXT NOT NULL CHECK (role IN ('member', 'admin', 'owner', 'ops'))
```
(L59)

#### ✅ 4. 冒頭コメント (L6-33)
以下の重要原則が明記されている:
- **owner 制約** (L19-21):
  - 各組織には owner が必ず1人必要
  - owner は削除不可
  - owner 交代は「譲渡」のみ許可
- **監査ログ** (L27-31):
  - 組織切替、ユーザーCRUD、ロール変更、支払い変更、組織凍結/廃止、owner譲渡を必ず記録
- **RLS 必須** (L13-16, L122):
  - "RLS を無効化・バイパスする実装は許可しない"
  - "org_id 単位のアクセス制御は必須"

#### ✅ 5. RLS ポリシー保留
```sql
-- TODO: RLS policies
```
(L104)

将来的なポリシー実装方針を記載 (L106-123)、ただし実装は先送り。

#### ✅ 6. RLS 有効化
```sql
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE activity_logs ENABLE ROW LEVEL SECURITY;
```
(L128-130)

### 追加確認事項

#### インデックス定義 (L93-98)
```sql
CREATE INDEX IF NOT EXISTS idx_profiles_user_id ON profiles(user_id);
CREATE INDEX IF NOT EXISTS idx_profiles_org_id ON profiles(org_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_org_id ON activity_logs(org_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_user_id ON activity_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_created_at ON activity_logs(created_at DESC);
```

#### 初期データ (L137-141)
開発用サンプル組織2件:
- `org_dummy_12345`: サンプル組織A (business プラン)
- `org_dummy_67890`: サンプル組織B (free プラン)

### 結論
✅ **ステップ2完了**: `infra/supabase/schema.sql` は全要件を満たしており、Supabase 統合の準備が整っている。

---

## 次のステップ

### ステップ3: Supabase 統合
- Supabase プロジェクト作成
- 環境変数設定 (`.env.local`)
- `schema.sql` を Supabase に適用
- Supabase Auth 設定
- `getCurrentRole()` / `getCurrentOrg()` 実装
- Session 管理と Cookie 設定
